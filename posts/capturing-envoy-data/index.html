<!doctype html><html lang=en><head><title>Capturing Envoy Data :: blog.oddbit.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Pursuant to my last post, I&amp;rsquo;ve written a simple man-in-the-middle proxy to intercept communication between the Envoy and the Enphase servers. The code is available here.
What it does As I detailed in my previous post, the Envoy sends data to Enphase via http POST requests. The proxy intercepts these requests, extracts the XML data from the request, and writes it to a local file (by default in /var/spool/envoy). It then forwards the request on to Enphase, and returns the reply to your Envoy."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/posts/capturing-envoy-data/><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Capturing Envoy Data"><meta property="og:description" content="Pursuant to my last post, I&amp;rsquo;ve written a simple man-in-the-middle proxy to intercept communication between the Envoy and the Enphase servers. The code is available here.
What it does As I detailed in my previous post, the Envoy sends data to Enphase via http POST requests. The proxy intercepts these requests, extracts the XML data from the request, and writes it to a local file (by default in /var/spool/envoy). It then forwards the request on to Enphase, and returns the reply to your Envoy."><meta property="og:url" content="https://blog.oddbit.com/posts/capturing-envoy-data/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2012-02-22 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/posts/capturing-envoy-data/>Capturing Envoy Data</a></h1><div class=post-meta><time class=post-date>2012-02-22 ::</time></div><div class=post-content><div><p>Pursuant to my <a href=http://blog.oddbit.com/2012/02/13/enphase-envoy-xml-data-format/>last post</a>, I&rsquo;ve written a simple man-in-the-middle proxy to intercept communication between the Envoy and the Enphase servers. The code is available <a href=https://github.com/larsks/envoy-tools>here</a>.</p><h2 id=what-it-does>What it does<a href=#what-it-does class=hanchor arialabel=Anchor>&#8983;</a></h2><p>As I detailed in my previous post, the Envoy sends data to Enphase via http <code>POST</code> requests. The proxy intercepts these requests, extracts the XML data from the request, and writes it to a local file (by default in <code>/var/spool/envoy</code>). It then forwards the request on to Enphase, and returns the reply to your Envoy.</p><p>In addition to extracting the XML data, the proxy also logs the complete contents (headers and message content) of the request and the reply to files.</p><h2 id=how-it-works>How it works<a href=#how-it-works class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Out of the box, your Envoy configures itself automatically using DHCP. Possibly, you&rsquo;ve configured it statically. In either case, it will typically be configured to connect via your default gateway &ndash; generally, your home router, cable modem, etc. In order to intercept the communication between the Envoy and Enphase, we insert another server between the Envoy and your network gateway. In the foollowing diagram, the dotted line represents the original communication path, while the solid lines represent the new communication path:</p><p><img src=/assets/2013/02/22/envoy-capture.png alt="envoy communication"></p><p>The intermediate system &ndash; which we&rsquo;ll call the interceptor &ndash; will use a few tricks to redirect traffic destined for Enphase to the local proxy (which will log the data locally and then forward it on to Enphase).</p><h2 id=assumptions>Assumptions<a href=#assumptions class=hanchor arialabel=Anchor>&#8983;</a></h2><p>For the purposes of this article, we&rsquo;ll assume that your Envoy is at address 192.168.1.100, and the address of the interceptor is 192.168.1.200.</p><p>I&rsquo;m assuming that your interceptor is running Linux. It may be possible to accomplish the same thing with other tools, but I&rsquo;m relying on the Linux netfilter subsystem (aka &ldquo;iptables&rdquo;) to perform certain key tasks.</p><h2 id=configuring-the-envoy>Configuring the Envoy<a href=#configuring-the-envoy class=hanchor arialabel=Anchor>&#8983;</a></h2><p>You will need to congfigure the Envoy to use your interceptor host as its default gateway.</p><ol><li>Go to the <a href="http://192.168.1.100/admin/lib/network_display?locale=en">network connectivity</a> page on your Envoy.</li><li>If it&rsquo;s checked, uncheck the &ldquo;Use DHCP&rdquo; setting and select the &ldquo;Updating DHCP setting&rdquo; button.</li><li>Set the &ldquo;Gateway IP&rdquo; field to the address of your interceptor (192.168.1.200 in this example).</li><li>Select the &ldquo;Update Interface 0&rdquo; button.</li></ol><h2 id=configuring-the-interceptor>Configuring the interceptor<a href=#configuring-the-interceptor class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=redirecting-requests>Redirecting requests<a href=#redirecting-requests class=hanchor arialabel=Anchor>&#8983;</a></h3><p>We need to configure the interceptor to redirect requests to the Enphase servers to a local application. We&rsquo;ll add the following firewall rule:</p><pre><code>iptables -t nat -A PREROUTING -s 192.168.1.100 -p tcp \
  --dport 443 -j REDIRECT --to-ports 4430
</code></pre><p>This rule matches https (port 443) requests from your Envoy (192.168.1.100) and redirects them to port 4430 on the interceptor.<br>Note that this rule will be lost if you reboot your system. Making firewall rules persistent is beyond the scope of this article; consult the documentation for your distribution of choice.</p><h3 id=handling-ssl>Handling SSL<a href=#handling-ssl class=hanchor arialabel=Anchor>&#8983;</a></h3><p>My simple Python proxy doesn&rsquo;t speak SSL, so we need to create a plain http request from the https request. Normally this would be difficult, but Enphase has made our life easier by not checking the validity of the SSL certificate. We&rsquo;re going to use <a href=http://www.stunnel.org/>stunnel</a> as an https-to-http proxy. Create a file called /etc/stunnel/envoy-ssl.conf with the following contents:</p><pre><code>[https_in]
accept = 4430
cert = /etc/pki/tls/certs/localhost.crt
connect = 127.0.0.1:8080
</code></pre><p>Run stunnel with this configuration:</p><pre><code>stunnel /etc/stunnel/envoy-ssl.conf
</code></pre><p>This assumes you have an SSL certificate in /etc/pki/tls/certs/localhost.crt. You will probably need to generate one, which again is left as an exercise to the reader.</p><h3 id=installing-bottle>Installing bottle<a href=#installing-bottle class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The proxy relies on the <a href=http://bottlepy.org/>bottle</a> Python web framework, which is probably not installed on your system. The easiest way to get things going is to install a Python &ldquo;virtual environment&rdquo; with the appropriate modules. Create a new virtual environment:</p><pre><code>virtualenv ~/env/envoy
</code></pre><p>And install bottle:</p><pre><code>~/env/envoy/bin/pip install bottle
</code></pre><h3 id=creating-directories>Creating directories<a href=#creating-directories class=hanchor arialabel=Anchor>&#8983;</a></h3><p>By default the proxy will write data to /var/spool/envoy. You&rsquo;ll need to make sure this directory exists and is writable by whatever account you&rsquo;re using to run the proxy.</p><h2 id=running-the-proxy>Running the proxy<a href=#running-the-proxy class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Now that you&rsquo;ve got all the prerequisites in place, you should be able to start the proxy by running:</p><pre><code>~/env/envoy/bin/python proxy.py
</code></pre><p>You should see something like this:</p><pre><code>Bottle server starting up (using WSGIRefServer())...
Listening on http://127.0.0.1:8080/
Hit Ctrl-C to quit.
</code></pre><p>Assuming that everything else went as planned, sometime within the next five minutes you should see the proxy service a request from your Envoy:</p><pre><code>localhost.localdomain - - [22/Feb/2012 09:03:57] &quot;POST /emu_reports/
performance_report?webcomm_version=3.0 HTTP/1.1&quot; 200 103
</code></pre><p>From this request you will end up with three files in /var/spool/envoy:</p><ul><li><p><code>2012-02-22T09:03:01-0j1FFs.xml</code><br>This is the XML data from the Envoy and is probably the most interesting file.</p></li><li><p><code>2012-02-22T09:03:01-ZMxw6b.request</code><br>This is the raw request from the Envoy.</p></li><li><p><code>2012-02-22T09:03:02-NB4DbR.response</code><br>This is the response from the Enphase servers.</p></li></ul><p>If you find some bugs, please let me know by creating a new issue <a href=https://github.com/larsks/envoy-tools/issues>here</a>. Note that this is only for bugs in the code; if you need basic networking tutorials and so forth the Google has lots of help for you.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>