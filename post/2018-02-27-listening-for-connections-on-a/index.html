<!doctype html><html lang=en><head><title>Listening for connections on all ports/any port :: blog.oddbit.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="On IRC &amp;ndash; and other online communities &amp;ndash; it is common to use a &amp;ldquo;pastebin&amp;rdquo; service to share snippets of code, logs, and other material, rather than pasting them directly into a conversation. These services will typically return a URL that you can share with others so that they can see the content in their browser.
One of my favorite pastebin services is termbin.com, because it works from the command line using tools you probably already have installed."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2018-02-27-listening-for-connections-on-a/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Listening for connections on all ports/any port"><meta property="og:description" content="On IRC &amp;ndash; and other online communities &amp;ndash; it is common to use a &amp;ldquo;pastebin&amp;rdquo; service to share snippets of code, logs, and other material, rather than pasting them directly into a conversation. These services will typically return a URL that you can share with others so that they can see the content in their browser.
One of my favorite pastebin services is termbin.com, because it works from the command line using tools you probably already have installed."><meta property="og:url" content="https://blog.oddbit.com/post/2018-02-27-listening-for-connections-on-a/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2018-02-27 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2018-02-27-listening-for-connections-on-a/>Listening for connections on all ports/any port</a></h1><div class=post-meta><time class=post-date>2018-02-27 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/networking/>networking</a>&nbsp;</span><div class=post-content><div><p>On <a href=https://en.wikipedia.org/wiki/Internet_Relay_Chat>IRC</a> &ndash; and other online communities &ndash; it is common to use a
&ldquo;pastebin&rdquo; service to share snippets of code, logs, and other
material, rather than pasting them directly into a conversation.
These services will typically return a URL that you can share with
others so that they can see the content in their browser.</p><p>One of my favorite pastebin services is <a href=http://termbin.com>termbin.com</a>, because it
works from the command line using tools you probably already have
installed. Termbin runs the <a href=https://github.com/solusipse/fiche>fiche</a> service, which listens for TCP
connections on port 9999, reads any content that you provide, and then
returns a URL. For example, if I wanted to share my <code>iptables</code>
configuration with someone I could just run:</p><pre><code>$ iptables-save | nc termbin.com 9999
http://termbin.com/gjfp
</code></pre><p>Visiting <a href=http://termbin.com/gjfp>http://termbin.com/gjfp</a> would show the output of that
command.</p><p>It&rsquo;s very convenient, but I found myself wondering: would it be
possible to configure things such that a service like <a href=https://github.com/solusipse/fiche>fiche</a>
could listen on <em>any</em> port?</p><p>I started by looking into <a href=https://en.wikipedia.org/wiki/Network_socket#Raw_socket>raw sockets</a>, but that turned out to be a
terrible idea. The solution was actually much simpler: use an
iptables <a href=http://ipset.netfilter.org/iptables-extensions.man.html#lbDM>REDIRECT</a> rule to take all traffic to a given ip address
and redirect it to the <a href=https://github.com/solusipse/fiche>fiche</a> service. This requires that you have
a spare ip address to dedicate to this service, but it is otherwise
very easy.</p><p>First, we start the <a href=https://github.com/solusipse/fiche>fiche</a> service:</p><pre><code>$ ./fiche
[Fiche][STATUS] Starting fiche on Tue Feb 27 11:53:01 2018...
[Fiche][STATUS] Domain set to: http://example.com.
[Fiche][STATUS] Server started listening on port: 9999.
============================================================
</code></pre><p>And we add an additional address to one of our network interfaces.
I&rsquo;m adding <code>192.168.1.250</code> to <code>eth0</code> on my local system:</p><pre><code>$ sudo ip addr add 192.168.1.250/32 dev eth0
</code></pre><p>Next, we create two firewall rules:</p><ul><li><p>One in the <code>nat</code> <code>PREROUTING</code> table, which will intercept traffic
from external systems:</p><pre><code>  $ sudo iptables -t nat -A PREROUTING -p tcp -d 192.168.1.250 -j REDIRECT --to-ports 9999
</code></pre></li><li><p>One in the <code>nat</code> <code>OUTPUT</code> table, which will intercept any locally
generated traffic:</p><pre><code>  $ sudo iptables -t nat -A OUTPUT -p tcp -d 192.168.1.250 -j REDIRECT --to-ports 9999
</code></pre></li></ul><p>These two rules will intercept any traffic &ndash; on <em>any</em> port &ndash; to
192.168.1.250 and redirect it to the <a href=https://github.com/solusipse/fiche>fiche</a> service.</p><p>For example, using no port (<code>nc</code> on my system defaults to port <code>0</code>):</p><pre><code>$ echo hello | nc 192.168.1.250
http://example.com/tfka
</code></pre><p>And any other port works as well:</p><pre><code>$ echo hello | nc 192.168.1.250 10
http://example.com/0j0c

$ echo hello | nc 192.168.1.250 80
http://example.com/u4fq
</code></pre><p>This solution will work with any TCP service. The service will need
to be listening on <code>INADDR_ANY</code> (<code>0.0.0.0</code>), because the <code>REDIRECT</code>
rule rewrites the destination address to &ldquo;the primary address of the
incoming interface&rdquo;.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script>
<script src=/js/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>