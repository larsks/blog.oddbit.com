<!doctype html><html lang=en><head><title>Safely restarting an OpenStack server with Ansible :: blog.oddbit.com</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The other day on #ansible, someone was looking for a way to safely shut down a Nova server, wait for it to stop, and then start it up again using the openstack cli. The first part seemed easy:
- hosts: myserver tasks: - name: shut down the server command: poweroff become: true &amp;hellip;but that will actually fail with the following result:
TASK [shut down server] ************************************* fatal: [myserver]: UNREACHABLE! =&amp;gt; {&amp;quot;changed&amp;quot;: false, &amp;quot;msg&amp;quot;: &amp;quot;Failed to connect to the host via ssh: Shared connection to 10."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2018-01-24-safely-restarting-an-openstack/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Safely restarting an OpenStack server with Ansible"><meta property="og:description" content="The other day on #ansible, someone was looking for a way to safely shut down a Nova server, wait for it to stop, and then start it up again using the openstack cli. The first part seemed easy:
- hosts: myserver tasks: - name: shut down the server command: poweroff become: true &amp;hellip;but that will actually fail with the following result:
TASK [shut down server] ************************************* fatal: [myserver]: UNREACHABLE! =&amp;gt; {&amp;quot;changed&amp;quot;: false, &amp;quot;msg&amp;quot;: &amp;quot;Failed to connect to the host via ssh: Shared connection to 10."><meta property="og:url" content="https://blog.oddbit.com/post/2018-01-24-safely-restarting-an-openstack/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2018-01-24 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2018-01-24-safely-restarting-an-openstack/>Safely restarting an OpenStack server with Ansible</a></h1><div class=post-meta><time class=post-date>2018-01-24 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/ansible/>ansible</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/openstack/>openstack</a>&nbsp;</span><div class=post-content><div><p>The other day on <a href=http://docs.ansible.com/ansible/latest/community.html#irc-channel>#ansible</a>, someone was looking for a way to safely
shut down a Nova server, wait for it to stop, and then start it up
again using the <code>openstack</code> cli. The first part seemed easy:</p><pre><code>- hosts: myserver
  tasks:
    - name: shut down the server
      command: poweroff
      become: true
</code></pre><p>&mldr;but that will actually fail with the following result:</p><pre><code>TASK [shut down server] *************************************
fatal: [myserver]: UNREACHABLE! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;:
&quot;Failed to connect to the host via ssh: Shared connection to
10.0.0.103 closed.\r\n&quot;, &quot;unreachable&quot;: true}
</code></pre><p>This happens because running <code>poweroff</code> immediately closes Ansible&rsquo;s
ssh connection. The workaround here is to use a &ldquo;fire-and-forget&rdquo;
<a href=http://docs.ansible.com/ansible/latest/playbooks_async.html>asynchronous task</a>:</p><pre><code>- hosts: myserver
  tasks:
     - name: shut down the server
       command: poweroff
       become: true
       async: 30
       poll: 0
</code></pre><p>The <code>poll: 0</code> means that Ansible won&rsquo;t wait around to check the result
of this task. Control will return to ansible immediately, so our
playbook can continue without errors resulting from the closed
connection.</p><p>Now that we&rsquo;ve started the shutdown process on the host, how do we
wait for it to complete? You&rsquo;ll see people solve this with a
<a href=http://docs.ansible.com/ansible/latest/pause_module.html>pause</a> task, but that&rsquo;s fragile because the timing there can be
tricky to get right.</p><p>Another option is to use something like Ansible&rsquo;s <a href=http://docs.ansible.com/ansible/latest/wait_for_module.html>wait_for</a> module.
For example, we could wait for <code>sshd</code> to become unresponsive:</p><pre><code>- name: wait for server to finishing shutting down
  wait_for:
    port: 22
    state: stopped
</code></pre><p>Be this is really just checking whether or not <code>sshd</code> is listening for
a connection, and <code>sshd</code> may shut down long before the system shutdown
process completes.</p><p>The best option is to ask Nova. We can query Nova for information
about a server using the Ansible&rsquo;s <a href=http://docs.ansible.com/ansible/latest/os_server_facts_module.html>os_server_facts</a> module. Like
the other OpenStack modules, this uses <a href=https://docs.openstack.org/os-client-config/latest/>os-client-config</a> to find
authentication credentials for your OpenStack environment. If you&rsquo;re
not explicitly providing authentication information in your playbook,
the module will use the <code>OS_*</code> environment variables that are commonly
used with the OpenStack command line tools.</p><p>The <code>os_server_facts</code> module creates an <code>openstack_servers</code> fact, the
value of which is a list of dictionaries which contains keys like
<code>status</code>, which is the one in which we&rsquo;re interested. A running
server has <code>status == "ACTIVE"</code> and a server that has been powered off
has <code>status == "SHUTOFF</code>.</p><p>Given the above, the &ldquo;wait for shutdown&rdquo; task would look something
like the following:</p><pre><code>- hosts: localhost
  tasks:
     - name: wait for server to stop
       os_server_facts:
         server: myserver
       register: results
       until: openstack_servers.0.status == &quot;SHUTOFF&quot;
       retries: 120
       delay: 5
</code></pre><p>You&rsquo;ll note that I&rsquo;m targeting <code>localhost</code> right now, because my local
system has access to my OpenStack environment and I have the necessary
credentials in my environment. If you need to run these tasks
elsewhere, you&rsquo;ll want to read up on how to provide credentials in
your playbook.</p><p>This task will retry up to <code>120</code> times, waiting <code>5</code> seconds between
tries, until the server reaches the desired state.</p><p>Next, we want to start the server back up. We can do this using
the <a href=http://docs.ansible.com/ansible/latest/os_server_action_module.html>os_server_action</a> module, using the <code>start</code> action. This task
also runs on <code>localhost</code>:</p><pre><code> - name: start the server
   os_server_action:
     server: larstest
     action: start
</code></pre><p>Finally, we want to wait for the host to come back up before we run
any additional tasks on it. In this case, we can&rsquo;t just look at the
status reported by Nova: the host will be <code>ACTIVE</code> from Nova&rsquo;s
perspective long before it is ready to accept <code>ssh</code> connections. Nor
can we use the <code>wait_for</code> module, since the <code>ssh</code> port may be open
before we are actually able to log in. The solution to this is the
<a href=http://docs.ansible.com/ansible/latest/wait_for_connection_module.html>wait_for_connection</a> module, which waits until Ansible is able to
successful execute an action on the target host:</p><pre><code>- hosts: larstest
  gather_facts: false
  tasks:
    - name: wait for server to start
      wait_for_connection:
</code></pre><p>We need to set <code>gather_facts: false</code> here because fact gathering
requires a functioning connection to the target host.</p><p>And that&rsquo;s it: a recipe for gently shutting down a remote host,
waiting for the shutdown to complete, then later on spinning it back
up and waiting until subsequent Ansible tasks will work correctly.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>