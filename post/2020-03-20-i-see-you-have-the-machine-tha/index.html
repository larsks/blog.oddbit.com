<!doctype html><html lang=en><head><title>I see you have the machine that goes ping... :: blog.oddbit.com</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="We&rsquo;re all looking for ways to keep ourselves occupied these days, and for me that means leaping at the chance to turn a small problem into a slightly ridiculous electronics project. For reasons that I won&rsquo;t go into here I wanted to generate an alert when a certain WiFi BSSID becomes visible. A simple solution to this problem would have been a few lines of shell script to send me an email&mldr;but this article isn&rsquo;t about simple solutions!"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2020-03-20-i-see-you-have-the-machine-tha/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG")}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="I see you have the machine that goes ping..."><meta property="og:description" content="We&rsquo;re all looking for ways to keep ourselves occupied these days, and for me that means leaping at the chance to turn a small problem into a slightly ridiculous electronics project. For reasons that I won&rsquo;t go into here I wanted to generate an alert when a certain WiFi BSSID becomes visible. A simple solution to this problem would have been a few lines of shell script to send me an email&mldr;but this article isn&rsquo;t about simple solutions!"><meta property="og:url" content="https://blog.oddbit.com/post/2020-03-20-i-see-you-have-the-machine-tha/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2020-03-20 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2020-03-20-i-see-you-have-the-machine-tha/>I see you have the machine that goes ping&mldr;</a></h1><div class=post-meta><time class=post-date>2020-03-20 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/arduino/>arduino</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/esp8266/>esp8266</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/micropython/>micropython</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/python/>python</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/wifi/>wifi</a>&nbsp;</span><div class=post-content><div><p>We&rsquo;re all looking for ways to keep ourselves occupied these days, and
for me that means leaping at the chance to turn a small problem into a
slightly ridiculous electronics project. For reasons that I won&rsquo;t go
into here I wanted to generate an alert when a certain WiFi BSSID
becomes visible. A simple solution to this problem would have been a
few lines of shell script to send me an email&mldr;but this article isn&rsquo;t
about simple solutions!</p><p>I thought it would be fun to put together a physical device of some
sort that would sound an alarm when the network in question was
visible. There weren&rsquo;t too many options floating around the house &ndash; I
found a <a href=https://www.amazon.com/RuiLing-Decibels-Continuous-Sounder-Electronic/dp/B07NK8MGL9>small buzzer</a>, but it wasn&rsquo;t very loud so wasn&rsquo;t much use
unless I was right next to it. I needed something a little more
dramatic, and found it in the old chime doorbell I had floating
around the basement. This means the problem statement became:</p><blockquote><p>Design a device that will ring the doorbell chime when a given BSSID
becomes visible.</p></blockquote><p>(Why a BSSID? The BSSID is the hardware address of the access point.
In most cases, it&rsquo;s easy to change the name of a WiFi network &ndash; the
SSID &ndash; but somewhat more difficult to change the BSSID.)</p><h1 id=tldr>TL;DR<a href=#tldr class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Before looking at the implementation in more detail, let&rsquo;s take a look
at the finished project. When the device detects a target BSSID, it
rings the bell twice and lights the <code>ALARM</code> LED:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/cT2JB-aDhTQ?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>After the initial alarm, the bell will ring once every five minutes
while the alarm persists. Once the BSSID goes offline, the device
cancels the alarm and extinguishes the <code>ALARM</code> LED:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/XY6YKFK2qv4?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>If the doorbell proves annoying, there&rsquo;s a switch that activates
silent mode:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/bgM7Asc4FD4?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>When silent mode is active, the device will illuminate the <code>ALARM</code> LED
without sounding the bell:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/xRxxqKiiYVc?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=but-wait-theres-more>But wait, there&rsquo;s more!<a href=#but-wait-theres-more class=hanchor arialabel=Anchor>&#8983;</a></h2><p>There&rsquo;s also a web interface that allows one to monitor and configure
the device. The web interface allows one to:</p><ul><li>See a list of visible networks</li><li>Add a network to the list of targets</li><li>Remove a network from the list of targets</li><li>See whether or not the scanning &ldquo;thread&rdquo; is active</li><li>See whether or not there is currently an active alarm</li></ul><p>Here&rsquo;s a video of it in action:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/TtDwYMXy-b8?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=and-thats-not-all>And that&rsquo;s not all!<a href=#and-thats-not-all class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In order to support the UI, there&rsquo;s a simple HTTP API that permits
programmatic interaction with the device. The API supports the
following endpoints:</p><ul><li><code>GET /api/target</code> &ndash; get a list of targets</li><li>`POST /api/target&rsquo; &ndash; add a BSSID to the list of targets</li><li><code>DELETE /api/target/&lt;bssid></code> &ndash; remove a BSSID from the list of
targets</li><li><code>GET /api/status</code> &ndash; get the current alarm status and whether or not
the scan is running</li><li><code>GET /api/scan/result</code> &ndash; get list of visible networks</li><li><code>GET /api/scan/start</code> &ndash; start the scan</li><li><code>GET /api/scan/stop</code> &ndash; stop the scan</li></ul><p>There are a couple of other methods, too, but they&rsquo;re more for
debugging than anything else.</p><h2 id=show-me-the-code>Show me the code!<a href=#show-me-the-code class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The code for this project is all online at
<a href=https://github.com/larsks/maxdetector>https://github.com/larsks/maxdetector</a>.</p><h1 id=implementation-details>Implementation details<a href=#implementation-details class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=software-notes>Software notes<a href=#software-notes class=hanchor arialabel=Anchor>&#8983;</a></h2><p>My initial inclination was to implement the entire solution in
<a href=https://micropython.org/>MicroPython</a> on an <a href=https://docs.wemos.cc/en/latest/d1/d1_mini.html>Wemos D1 mini</a> (an <a href=https://en.wikipedia.org/wiki/ESP8266>esp8266</a> development
board), but this proved problematic: MicroPython&rsquo;s <code>network.WLAN.scan</code>
method is a blocking operation, by which I mean it blocks
<em>everything</em>, including interrupt handling, timer tasks, etc. This
made it difficult to handle some physical UI aspects, such as button
debouncing, in a reliable fashion.</p><p>I ended up moving the physical UI aspects to an <a href=https://store.arduino.cc/usa/arduino-uno-rev3>Arduino Uno</a>. The
ESP8266 handles scanning for WiFi networks, and raises a signal to the
Uno when an alarm is active. The Uno handles the silent mode button,
the LEDs, and the relay attached to the doorbell.</p><p>After the initial implementation, I realized that it really need a web
interface (because of course it does), so in addition to the WiFi
scanning the ESP8266 now hosts a simple web server. Because of the
blocking nature of the WiFi scan, this means the web server may
occasionally pause for a few seconds, but this hasn&rsquo;t proven to be a
problem.</p><p>In the end, I have four major blocks of code in three different languages:</p><ul><li><a href=https://github.com/larsks/maxdetector/blob/master/maxdetector.py>maxdetector.py</a> implements the WiFi scanning</li><li><a href=https://github.com/larsks/maxdetector/blob/master/server.py>server.py</a> implements the server side of the web interface</li><li><a href=https://github.com/larsks/maxdetector/blob/master/static/md.js>md.js</a> implements the dynamic portion of the web interface</li><li><a href=https://github.com/larsks/maxdetector/blob/master/src/maxdetector.cpp>maxdetector.cpp</a> implements the physical UI and operates the doorbell</li></ul><h3 id=wifi-scanning>Wifi scanning<a href=#wifi-scanning class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The WiFi scanning operation is implemented as a &ldquo;background task&rdquo;
driven by a MicroPython <a href=https://docs.micropython.org/en/latest/esp8266/quickref.html#timers>virtual timer</a>. The scanning task triggers
once every 10 seconds (and takes a little over 2 seconds to complete).</p><h3 id=web-server>Web server<a href=#web-server class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The web server is a simple <code>select.poll()</code> based server capable of
servicing multiple clients (very, very slowly). I was interested in an
<code>asyncio</code> implementation, but at the time the only <code>asyncio</code>
module for MicroPython was the one in <a href=https://github.com/micropython/micropython-lib>micropython-lib</a>, which
hadn&rsquo;t been touched in several years. A new <code>asyncio</code> module has
recently been <a href=https://github.com/micropython/micropython/commit/1d4d688b3b251120f5827a3605ec232d977eaa0f>added to micropython</a>, but that post-dates the
implementation of this project.</p><p>The server uses a very simple route-registration mechanism that should
be familiar if you&rsquo;ve worked with various other Python web frameworks.
It would be relatively easy to repurpose it for something other than
this project.</p><h2 id=the-hardware>The hardware<a href=#the-hardware class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Everything is bundled &ldquo;neatly&rdquo; (whereby &ldquo;neatly&rdquo; I mean &ldquo;haphazardly&rdquo;)
into an old shoe box. On the outside, you can see the three LEDs (for
the ACTIVE, SILENT, and ALARM signals), the SILENT switch, and the
doorbell itself:</p><figure class=left><img src=detector-outside-labelled.png></figure><p>On the inside, you&rsquo;ll find the Arduino Uno, the Wemos D1 mini, the
relay, and a step-down converter:</p><figure class=left><img src=detector-inside-labelled.png></figure><p>The step-down converter isn&rsquo;t actually necessary: when I put things
together, I didn&rsquo;t realize that the Uno would accept up to 12V into
its regulator. Since I already had the step-down converter in place,
I&rsquo;m feeding about 7.5v to the Uno. The doorbell gets 12V.</p><p>I initially prototyped the circuit in <a href=https://www.tinkercad.com/things/cpRuevAoV5L-max-detector>Tinkercad Circuits</a>, where
everything worked just fine. But after wiring things up and testing out
the device, it would start ringing endlessly. Upon inspection, this
was because the Uno was resetting every time the doorbell chimed. This
was due to flyback voltage from the relay, which is simple to fix if
you happen to have an appropriate diode handy&mldr;but if you don&rsquo;t, it
means calling around to all your aquaintenances to find someone who
happens to have some lying around. With a diode in place, everything
worked swimmingly.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>