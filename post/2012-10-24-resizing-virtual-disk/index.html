<!doctype html><html lang=en><head><title>Growing a filesystem on a virtual disk :: blog.oddbit.com</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Occasionally we will deploy a virtual instance into our KVM infrastructure and realize after the fact that we need more local disk space available. This is the process we use to expand the disk image. This process assumes the following:
You&amp;rsquo;re using legacy disk partitions. The process for LVM is similar and I will describe that in another post (it&amp;rsquo;s generally identical except for an additional pvresize thrown in and lvextend in place of resize2fs)."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2012-10-24-resizing-virtual-disk/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG")}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Growing a filesystem on a virtual disk"><meta property="og:description" content="Occasionally we will deploy a virtual instance into our KVM infrastructure and realize after the fact that we need more local disk space available. This is the process we use to expand the disk image. This process assumes the following:
You&amp;rsquo;re using legacy disk partitions. The process for LVM is similar and I will describe that in another post (it&amp;rsquo;s generally identical except for an additional pvresize thrown in and lvextend in place of resize2fs)."><meta property="og:url" content="https://blog.oddbit.com/post/2012-10-24-resizing-virtual-disk/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2012-10-24 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2012-10-24-resizing-virtual-disk/>Growing a filesystem on a virtual disk</a></h1><div class=post-meta><time class=post-date>2012-10-24 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/virtualization/>virtualization</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/kvm/>kvm</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/storage/>storage</a>&nbsp;</span><div class=post-content><div><p>Occasionally we will deploy a virtual instance into our KVM
infrastructure and realize after the fact that we need more local disk
space available. This is the process we use to expand the disk image.
This process assumes the following:</p><ul><li>You&rsquo;re using legacy disk partitions. The process for LVM is similar
and I will describe that in another post (it&rsquo;s generally identical
except for an additional <code>pvresize</code> thrown in and <code>lvextend</code> in
place of <code>resize2fs</code>).</li><li>The partition you need to resize is the last partition on the disk.</li></ul><p>This process will work with either a <code>qcow2</code> or <code>raw</code> disk image. For
<code>raw</code> images you can also run <code>fdisk</code> on the host, potentially saving
yourself a reboot, but that&rsquo;s less convenient for <code>qcow2</code> format
images.</p><hr><p>We start with a 5.5G root filesystem with 4.4G free:</p><pre><code>[root@localhost ~]# df -h /
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda2       5.5G  864M  4.4G  17% /
</code></pre><p>We need to shut down the system to grow the underlying image:</p><pre><code>[root@localhost ~]# poweroff
</code></pre><p>On the host, we use the <code>qemu-img resize</code> command to grow the image.
First we need the path to the underlying disk image:</p><pre><code>[lars@madhatter blog]$ virsh -c qemu:///system dumpxml lars-test-0 | grep file
    &lt;disk type='file' device='disk'&gt;
      &lt;source file='/var/lib/libvirt/images/lars-test-0-1.img'/&gt;
</code></pre><p>And now we increase the image size by 10G:</p><pre><code>[lars@madhatter blog]$ sudo qemu-img resize /var/lib/libvirt/images/lars-test-0.img +10G
Image resized.
</code></pre><p>Now reboot the instance:</p><pre><code>[lars@madhatter blog]$ virsh -c qemu:///system start lars-test-0
</code></pre><p>And login in on the console:</p><pre><code>[lars@madhatter blog]$ virsh -c qemu:///system console lars-test-0
Connected to domain lars-test-0
Escape character is ^]

Fedora release 17 (Beefy Miracle)
Kernel 3.6.2-4.fc17.x86_64 on an x86_64 (ttyS0)

localhost login: root
Password:
</code></pre><p>We&rsquo;re going to use <code>fdisk</code> to modify the partition layout. Run
<code>fdisk</code> on the system disk:</p><pre><code>[root@localhost ~]# fdisk /dev/vda
Welcome to fdisk (util-linux 2.21.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.
</code></pre><p>Print out the existing partition table and verify that you really are
going to be modifying the final partition:</p><pre><code>Command (m for help): p

Disk /dev/vda: 19.3 GB, 19327352832 bytes
16 heads, 63 sectors/track, 37449 cylinders, total 37748736 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x00007d9f

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048     1026047      512000   83  Linux
/dev/vda2         1026048     5154815     2064384   82  Linux swap / Solaris
/dev/vda3         5154816    16777215     5811200   83  Linux
</code></pre><p>Delete and recreate the final partition, in this case <code>/dev/vda3</code>&mldr;</p><pre><code>Command (m for help): d
Partition number (1-4): 3
Partition 3 is deleted
</code></pre><p>&mldr;and create a new partition, accepting all the defaults. This will
create a new partition starting in the same place and extending to the
end of the disk:</p><pre><code>Command (m for help): n
Partition type:
   p   primary (2 primary, 0 extended, 2 free)
   e   extended
Select (default p): p
Partition number (1-4, default 3): 3
First sector (5154816-37748735, default 5154816): 
Using default value 5154816
Last sector, +sectors or +size{K,M,G} (5154816-37748735, default 37748735): 
Using default value 37748735
Partition 3 of type Linux and of size 15.6 GiB is set
</code></pre><p>You can print out the new partition table to see that indeed
<code>/dev/vda3</code> is now larger:</p><pre><code>Command (m for help): p

Disk /dev/vda: 19.3 GB, 19327352832 bytes
16 heads, 63 sectors/track, 37449 cylinders, total 37748736 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x00007d9f

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048     1026047      512000   83  Linux
/dev/vda2         1026048     5154815     2064384   82  Linux swap / Solaris
/dev/vda3         5154816    37748735    16296960   83  Linux
</code></pre><p>Write the changes to disk:</p><pre><code>Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.

WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
</code></pre><p><strong>Note the warning!</strong> The kernel has cached a copy of the old
partition table. We need to reboot the system before our changes are
visible! So we reboot the system:</p><pre><code>[root@localhost ~]# reboot
</code></pre><p>And log back in. Run <code>df</code> to see the current size of the root
filesystem:</p><pre><code>[root@localhost ~]# df -h /
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda3       5.5G  864M  4.4G  17% /
</code></pre><p>Now run <code>resize2fs</code> to resize the root filesystem so that it expands
to fill our extended <code>/dev/vda3</code>:</p><pre><code>[root@localhost ~]# resize2fs /dev/vda3
resize2fs 1.42.3 (14-May-2012)
Filesystem at /dev/vda3 is mounted on /; on-line resizing required
old_desc_blocks = 1, new_desc_blocks = 1
The filesystem on /dev/vda3 is now 4074240 blocks long.
</code></pre><p>Run <code>df</code> again to see that we now have additional space available:</p><pre><code>[root@localhost ~]# df -h /
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda3        16G  867M   14G   6% /
[root@localhost ~]# 
</code></pre></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>