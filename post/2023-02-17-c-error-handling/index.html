<!doctype html><html lang=en><head><title>Simple error handling in C :: blog.oddbit.com</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='Overview I was recently working with someone else&rsquo;s C source and I wanted to add some basic error checking without mucking up the code with a bunch of if statements and calls to perror. I ended up implementing a simple must function that checks the return value of an expression, and exits with an error if the return value is less than 0. You use it like this:
must(fd = open("textfile.txt", O_RDONLY)); Or:
'><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2023-02-17-c-error-handling/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG")}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Simple error handling in C"><meta property="og:description" content='Overview I was recently working with someone else&rsquo;s C source and I wanted to add some basic error checking without mucking up the code with a bunch of if statements and calls to perror. I ended up implementing a simple must function that checks the return value of an expression, and exits with an error if the return value is less than 0. You use it like this:
must(fd = open("textfile.txt", O_RDONLY)); Or:
'><meta property="og:url" content="https://blog.oddbit.com/post/2023-02-17-c-error-handling/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2023-02-17 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2023-02-17-c-error-handling/>Simple error handling in C</a></h1><div class=post-meta><time class=post-date>2023-02-17 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/c/>c</a>&nbsp;
</span><img src=/post/2023-02-17-c-error-handling/cover.jpg class=post-cover alt="Simple error handling in C" title="Cover Image"><div class=post-content><div><h2 id=overview>Overview<a href=#overview class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I was recently working with someone else&rsquo;s C source and I wanted to add some basic error checking without mucking up the code with a bunch of <code>if</code> statements and calls to <code>perror</code>. I ended up implementing a simple <code>must</code> function that checks the return value of an expression, and exits with an error if the return value is less than 0. You use it like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>must</span>(fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#34;textfile.txt&#34;</span>, O_RDONLY));
</span></span></code></pre></div><p>Or:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>must</span>(<span style=color:#a6e22e>close</span>(fd));
</span></span></code></pre></div><p>In the event that an expression returns an error, the code will exit with a message that shows the file, line, and function in which the error occurred, along with the actual text of the called function and the output of <code>perror</code>:</p><pre tabindex=0><code>example.c:24 in main: fd = open(&#34;does-not-exist.xt&#34;, O_RDONLY): [2]: No such file or directory
</code></pre><p>To be clear, this is only useful when you&rsquo;re using functions that conform to standard Unix error reporting conventions, and if you&rsquo;re happy with &ldquo;exit with an error message&rdquo; as the failure handling mechanism.</p><h2 id=implementation>Implementation<a href=#implementation class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The implementation starts with a macro defined in <code>must.h</code>:</p><div class=collapsable-code><input id=362781495 type=checkbox>
<label for=362781495><span class=collapsable-code__language>c</span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span></label><pre class=language-c><code>


#ifndef _MUST
#define _MUST

#define must(x) _must(__FILE__, __LINE__, __func__, #x, (x))

void _must(const char *fileName, int lineNumber, const char *funcName,
           const char *calledFunction, int err);
#endif



</code></pre></div><p>The <code>__FILE__</code>, <code>__LINE__</code>, and <code>__func__</code> symbols are standard predefined symbols provided by <code>gcc</code>; they are documented <a href=https://gcc.gnu.org/onlinedocs/cpp/Standard-Predefined-Macros.html>here</a>. The expression <code>#x</code> is using the <a href=https://gcc.gnu.org/onlinedocs/cpp/Stringizing.html#Stringizing>stringify</a> operator to convert the macro argument into a string.</p><p>The above macro transforms a call to <code>must()</code> into a call to the <code>_must()</code> function, which is defined in <code>must.c</code>:</p><div class=collapsable-code><input id=794162835 type=checkbox>
<label for=794162835><span class=collapsable-code__language>c</span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span></label><pre class=language-c><code>

#include &#34;must.h&#34;

#include &lt;errno.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

void _must(const char *fileName, int lineNumber, const char *funcName,
           const char *calledFunction, int err) {
  if (err &lt; 0) {
    char buf[256];
    snprintf(buf, 256, &#34;%s:%d in %s: %s: [%d]&#34;, fileName, lineNumber, funcName,
             calledFunction, errno);
    perror(buf);
    exit(1);
  }
}



</code></pre></div><p>In this function we check the value of <code>err</code> (which will be the return value of the expression passed as the argument to the <code>must()</code> macro), and if it evaluates to a number less than 0, we use <code>snprintf()</code> to generate a string that we can pass to <code>perror()</code>, and finally call <code>perror()</code> which will print our information string, a colon, and then the error message corresponding to the value of <code>errno</code>.</p><h2 id=example>Example<a href=#example class=hanchor arialabel=Anchor>&#8983;</a></h2><p>You can see <code>must()</code> used in practice in the following example program:</p><div class=collapsable-code><input id=348296715 type=checkbox>
<label for=348296715><span class=collapsable-code__language>c</span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span></label><pre class=language-c><code>

#include &#34;must.h&#34;
#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main() {
  int fd;
  char buf[1024];

  printf(&#34;opening a file that does exist\n&#34;);
  must(fd = open(&#34;file-that-exists.txt&#34;, O_RDONLY));

  while (1) {
    int nb;
    must(nb = read(fd, buf, sizeof(buf)));
    if (!nb)
      break;
    must(write(STDOUT_FILENO, buf, nb));
  }

  must(close(fd));

  printf(&#34;opening a file that doesn&#39;t exist\n&#34;);
  must(fd = open(&#34;file-that-does-not-exist.xt&#34;, O_RDONLY));
  return 0;
}



</code></pre></div><p>Provided the <code>file-that-exists.txt</code> (a) exists and (b) contains the text <code>Hello, world.</code>, and that <code>file-that-does-not-exist.txt</code> does not, in fact, exist, running the above code will produce the following output:</p><pre tabindex=0><code>opening a file that does exist
Hello, world.
opening a file that doesn&#39;t exist
example.c:24 in main: fd = open(&#34;file-that-does-not-exist.xt&#34;, O_RDONLY): [2]: No such file or directory
</code></pre></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>