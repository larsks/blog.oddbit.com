<!doctype html><html lang=en><head><title>Docker build learns about secrets and ssh agent forwarding :: blog.oddbit.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A common problem for folks working with Docker is accessing resources which require authentication during the image build step. A particularly common use case is getting access to private git repositories using ssh key-based authentication. Until recently there hasn&amp;rsquo;t been a great solution:
you can embed secrets in your image, but now you can&amp;rsquo;t share the image with anybody. you can use build arguments, but this requires passing in an unenecrypted private key on the docker build command line, which is suboptimal for a number of reasons you can perform all the steps requiring authentication at runtime, but this can needlessly complicate your container startup process."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2019-02-24-docker-build-learns-about-secr/><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Docker build learns about secrets and ssh agent forwarding"><meta property="og:description" content="A common problem for folks working with Docker is accessing resources which require authentication during the image build step. A particularly common use case is getting access to private git repositories using ssh key-based authentication. Until recently there hasn&amp;rsquo;t been a great solution:
you can embed secrets in your image, but now you can&amp;rsquo;t share the image with anybody. you can use build arguments, but this requires passing in an unenecrypted private key on the docker build command line, which is suboptimal for a number of reasons you can perform all the steps requiring authentication at runtime, but this can needlessly complicate your container startup process."><meta property="og:url" content="https://blog.oddbit.com/post/2019-02-24-docker-build-learns-about-secr/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2019-02-24 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2019-02-24-docker-build-learns-about-secr/>Docker build learns about secrets and ssh agent forwarding</a></h1><div class=post-meta><time class=post-date>2019-02-24 ::</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/docker/>docker</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/secrets/>secrets</a>&nbsp;</span><div class=post-content><div><p>A common problem for folks working with Docker is accessing resources which require authentication during the image build step. A particularly common use case is getting access to private git repositories using ssh key-based authentication. Until recently there hasn&rsquo;t been a great solution:</p><ul><li>you can embed secrets in your image, but now you can&rsquo;t share the image with anybody.</li><li>you can use build arguments, but this requires passing in an unenecrypted private key on the <code>docker build</code> command line, which is suboptimal for a number of reasons</li><li>you can perform all the steps requiring authentication at runtime, but this can needlessly complicate your container startup process.</li></ul><p>With Docker 18.09, there are some experimental features available that makes this much easier. You can read the official announcement <a href=https://docs.docker.com/develop/develop-images/build_enhancements/>here</a>, but I wanted to highlight the support for ssh agent forwarding and private keys.</p><h1 id=prerequisites>Prerequisites<a href=#prerequisites class=hanchor arialabel=Anchor>&#8983;</a></h1><p>In order to use the new features, you first need to explicitly enable BuildKit support by setting <code>DOCKER_BUILDKIT=1</code> in your environment:</p><pre><code>export DOCKER_BUILDKIT=1
</code></pre><p>And to utilize the new <code>Dockerfile</code> syntax, you need to start your <code>Dockerfile</code> with this directive:</p><pre><code># syntax=docker/dockerfile:1.0.0-experimental
</code></pre><p>That instructs Docker to use the named image (<code>docker/dockerfile:1.0.0-experimental</code>) to handle the image build process.</p><h2 id=a-simple-example>A simple example<a href=#a-simple-example class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The most common use case will probably be forwarding access to your local ssh agent. In order for the build process to get access to your agent, two things must happen:</p><ol><li><p>The <code>RUN</code> command that requires credentials must specify <code>--mount=type=ssh</code> in order to have access to the forwarded agent connection, and</p></li><li><p>You must pass an appropriate <code>--ssh</code> option on the <code>docker build</code> command line. This is to prevent a Dockerfile from unexpectedly gaining access to your ssh credentials.</p></li></ol><p>We can see this in action if we start with the following <code>Dockerfile</code>:</p><pre><code># syntax=docker/dockerfile:1.0.0-experimental

FROM alpine
RUN apk add --update git openssh

# This is necessary to prevent the &quot;git clone&quot; operation from failing
# with an &quot;unknown host key&quot; error.
RUN mkdir -m 700 /root/.ssh; \
  touch -m 600 /root/.ssh/known_hosts; \
  ssh-keyscan github.com &gt; /root/.ssh/known_hosts

# This command will have access to the forwarded agent (if one is
# available)
RUN --mount=type=ssh git clone git@github.com:moby/buildkit
</code></pre><p>If we run build the image like this&mldr;</p><pre><code>export DOCKER_BUILDKIT=1
docker build --ssh default -t buildtest .
</code></pre><p>&mldr;then our <code>git clone</code> operation will successfully authenticate with github using our ssh private key, assuming that we had one loaded into our local ssh agent.</p><h2 id=but-wait-theres-more>But wait, there&rsquo;s more<a href=#but-wait-theres-more class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In the previous example line, the <code>--ssh default</code> option requests <code>docker build</code> to forward your default ssh agent. There may be situations in which this isn&rsquo;t appropriate (for example, maybe you need to use a key that isn&rsquo;t loaded into your default agent). You can provide the <code>--ssh</code> option with one or more paths to ssh agent sockets or (unencrypted) private key files. Let&rsquo;s say you have two service-specific private keys:</p><ul><li>For GitHub, you need to use <code>$HOME/.ssh/github_rsa</code></li><li>For BitBucket, you need to use <code>$HOME/.ssh/bitbucket_rsa</code></li></ul><p>You can provide the keys on the <code>docker build</code> command line like this:</p><pre><code>docker build --ssh github=$HOME/.ssh/github_rsa,bitbucket=$HOME/.ssh/bitbucket_rsa -t buildtest .
</code></pre><p>Then inside your <code>Dockerfile</code>, you can use the <code>id=&lt;name></code> parameter to the <code>--mount</code> option to specify which key should be available to the <code>RUN</code> command:</p><pre><code># syntax=docker/dockerfile:1.0.0-experimental

FROM alpine
RUN apk add --update git openssh

# This is necessary to prevent the &quot;git clone&quot; operation from failing
# with an &quot;unknown host key&quot; error.
RUN mkdir -m 700 /root/.ssh; \
  touch -m 600 /root/.ssh/known_hosts; \
  ssh-keyscan github.com bitbucket.com &gt; /root/.ssh/known_hosts

# This command has access to the &quot;github&quot; key
RUN --mount=type=ssh,id=github git clone git@github.com:some/project

# This command has access to the &quot;bitbucket&quot; key
RUN --mount=type=ssh,id=bitbucket git clone git@bitbucket.com:other/project
</code></pre><h2 id=other-secrets>Other secrets<a href=#other-secrets class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In this post I&rsquo;ve looked specfically at providing <code>docker build</code> with access to your ssh keys. Docker 18.09 also introduces support for exposing other secrets to the build process; see the official announcement (linked above) for details.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>