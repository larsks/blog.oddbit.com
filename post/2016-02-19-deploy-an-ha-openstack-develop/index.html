<!doctype html><html lang=en><head><title>Deploying an HA OpenStack development environment with tripleo-quickstart
:: blog.oddbit.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this article I would like to introduce tripleo-quickstart, a tool that will automatically provision a virtual environment and then use TripleO to deploy an HA OpenStack on top of it.
Introducing Tripleo-Quickstart The goal of the Tripleo-Quickstart project is to replace the instack-virt-setup tool for quickly setting up virtual TripleO environments, and to ultimately become the tool used by both developers and upstream CI for this purpose. The project is a set of Ansible playbooks that will take care of:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2016-02-19-deploy-an-ha-openstack-develop/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Deploying an HA OpenStack development environment with tripleo-quickstart
"><meta property="og:description" content="In this article I would like to introduce tripleo-quickstart, a tool that will automatically provision a virtual environment and then use TripleO to deploy an HA OpenStack on top of it.
Introducing Tripleo-Quickstart The goal of the Tripleo-Quickstart project is to replace the instack-virt-setup tool for quickly setting up virtual TripleO environments, and to ultimately become the tool used by both developers and upstream CI for this purpose. The project is a set of Ansible playbooks that will take care of:"><meta property="og:url" content="https://blog.oddbit.com/post/2016-02-19-deploy-an-ha-openstack-develop/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2016-02-19 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2016-02-19-deploy-an-ha-openstack-develop/>Deploying an HA OpenStack development environment with tripleo-quickstart</a></h1><div class=post-meta><time class=post-date>2016-02-19 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/openstack/>openstack</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/tripleo/>tripleo</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/rdo/>rdo</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/ansible/>ansible</a>&nbsp;</span><div class=post-content><div><p>In this article I would like to introduce <a href=https://github.com/redhat-openstack/tripleo-quickstart>tripleo-quickstart</a>, a
tool that will automatically provision a virtual environment and then
use <a href=http://docs.openstack.org/developer/tripleo-docs/>TripleO</a> to deploy an HA OpenStack on top of it.</p><h2 id=introducing-tripleo-quickstart>Introducing Tripleo-Quickstart<a href=#introducing-tripleo-quickstart class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The goal of the <a href=https://github.com/redhat-openstack/tripleo-quickstart>Tripleo-Quickstart</a> project is to replace the
<code>instack-virt-setup</code> tool for quickly setting up virtual TripleO
environments, and to ultimately become the tool used by both
developers and upstream CI for this purpose. The project is a set of
<a href=http://ansible.com/>Ansible</a> playbooks that will take care of:</p><ul><li>Creating virtual undercloud node</li><li>Creating virtual overcloud nodes</li><li>Deploying the undercloud</li><li>Deploying the overcloud</li><li>Validating the overcloud</li></ul><p>In this article, I will be using <code>tripleo-quickstart</code> to set up a
development environment on a 32GB desktop. This is probably the
minimum sized system if your goal is to create an HA install (a
single controller/single compute environment could be deployed on
something smaller).</p><h2 id=requirements>Requirements<a href=#requirements class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Before we get started, you will need:</p><ul><li><p>A target system with at least 32GB of RAM.</p></li><li><p>Ansible 2.0.x. This is what you get if you <code>pip install ansible</code>;
it is also available in the Fedora <code>updates-testing</code> repository and
in the EPEL <code>epel-testing</code> repository.</p><p>Do <strong>not</strong> use Ansible from the HEAD of the git repository; the
development version is not necessarily backwards compatible with
2.0.x and may break in unexpected ways.</p></li><li><p>A user account on the target system with which you can (a) log in
via ssh without a password and (b) use <code>sudo</code> without a password to
gain root privileges. In other words, this should work:</p><pre><code>    ssh -tt targetuser@targethost sudo echo it worked
</code></pre><p>Your <em>targetuser</em> could be <code>root</code>, in which case the <code>sudo</code> is
superfluous and you should be all set.</p></li><li><p>A copy of the tripleo-quickstart repository:</p><pre><code>  git clone https://github.com/redhat-openstack/tripleo-quickstart/
</code></pre></li></ul><p>The remainder of this document assumes that you are running things
from inside the <code>tripleo-quickstart</code> directory.</p><h2 id=the-quick-way>The quick way<a href=#the-quick-way class=hanchor arialabel=Anchor>&#8983;</a></h2><p>If you just want to take things out for a spin using the defaults
<em>and</em> you can ssh to your target host as <code>root</code>, you can skip the
remainder of this article and just run:</p><pre><code>ansible-playbook playbooks/centosci/minimal.yml \
  -e virthost=my.target.host
</code></pre><p>Or for an HA deployment:</p><pre><code>ansible-playbook playbooks/centosci/ha.yml \
  -e virthost=my.target.host
</code></pre><p>(Where you replace <code>my.target.host</code> with the hostname of the host on
which you want to install your virtual environment.)</p><p>In the remainder of this article I will discuss ways in which you can
customize this process (and make subsequent deployments faster).</p><h2 id=create-an-inventory-file>Create an inventory file<a href=#create-an-inventory-file class=hanchor arialabel=Anchor>&#8983;</a></h2><p>An inventory file tells Ansible to which hosts it should connect and
provides information about how it should connect. For the quickstart,
your inventory needs to have your target host listed in the <code>virthost</code>
group. For example:</p><pre><code>[virthost]
my.target.host ansible_user=targetuser
</code></pre><p>I&rsquo;m going to assume you put this into a file named <code>inventory</code>.</p><h2 id=creating-a-playbook>Creating a playbook<a href=#creating-a-playbook class=hanchor arialabel=Anchor>&#8983;</a></h2><p>A playbook tells Ansible what do to do.</p><p>First, we want to tear down any existing virtual environment, and then
spin up a new undercloud node and create guests that will be used as
overcloud nodes. We do this with the <code>libvirt/teardown</code> and
<code>libvirt/setup</code> roles:</p><pre><code>- hosts: virthost
  roles:
    - libvirt/teardown
    - libvirt/setup
</code></pre><p>The next play will generate an Ansible inventory file (by default
<code>$HOME/.quickstart/hosts</code>) that we can use in the future to refer to
our deployment:</p><pre><code>- hosts: localhost
  roles:
    - rebuild-inventory
</code></pre><p>Lastly, we install the undercloud host and deploy the overcloud:</p><pre><code>- hosts: undercloud
  roles:
    - overcloud
</code></pre><p>Put this content in a file named <code>ha.yml</code> (the actual name doesn&rsquo;t
matter, but this gives us something to refer to later on in this
article).</p><h2 id=configuring-the-deployment>Configuring the deployment<a href=#configuring-the-deployment class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Before we run tripleo-quickstart, we need to make a few configuration
changes. We&rsquo;ll do this by creating a <a href=http://yaml.org/>YAML</a> file that describes our
configuration, and we&rsquo;ll feed this to ansible using the <a href=http://docs.ansible.com/ansible/playbooks_variables.html#passing-variables-on-the-command-line>-e
@filename.yml</a> syntax.</p><h3 id=describing-your-virtual-servers>Describing your virtual servers<a href=#describing-your-virtual-servers class=hanchor arialabel=Anchor>&#8983;</a></h3><p>By default, tripleo-quickstart will deploy an environment consisting
of four overcloud nodes:</p><ul><li>3 controller nodes</li><li>1 compute node</li></ul><p>All of these will have 4GB of memory, which when added to the default
overcloud node size of 12GB comes to a total memory footprint of 24GB.
These defaults are defined in
<code>playbooks/roles/nodes/defaults/main.yml</code>. There are a number of ways
we can override this default configuration.</p><p>To simply change the amount of memory assigned to each class of
server, we can set the <code>undercloud_memory</code>, <code>control_memory</code>, and
<code>compute_memory</code> keys. For example:</p><pre><code>control_memory: 6000
compute_memory: 2048
</code></pre><p>To change the number of CPUs assigned to a server, we can change the
corresponding <code>_vcpu</code> key. Your deployments will generally run faster
if your undercloud host has more CPUs available:</p><pre><code>undercloud_vcpu: 4
</code></pre><p>To change the number and type of nodes, you can provide an
<code>overcloud_nodes</code> key with entries for each virtual system. The
default looks like this:</p><pre><code>overcloud_nodes:
  - name: control_0
    flavor: control
  - name: control_1
    flavor: control
  - name: control_2
    flavor: control

  - name: compute_0
    flavor: compute
</code></pre><p>To create a minimal environment with a single controller and a single
compute node, we could instead put the following into our configuration
file:</p><pre><code>overcloud_nodes:
  - name: control_0
    flavor: control
  - name: compute_0
    flavor: compute
</code></pre><p>You may intuit from the above examples that you can actually describe
custom flavors. This is true, but is beyond the scope of this post;
take a look at <code>playbooks/roles/nodes/defaults/main.yml</code> for an
example.</p><h3 id=configuring-ha>Configuring HA<a href=#configuring-ha class=hanchor arialabel=Anchor>&#8983;</a></h3><p>To actually deploy an HA OpenStack environment, we need to pass a few
additional options to the <code>openstack overcloud deploy</code> command. Based
on <a href=http://docs.openstack.org/developer/tripleo-docs/basic_deployment/basic_deployment_cli.html#deploy-the-overcloud>the docs</a> I need:</p><pre><code>--control-scale 3 \
-e /usr/share/openstack-tripleo-heat-templates/environments/puppet-pacemaker.yaml \
--ntp-server pool.ntp.org
</code></pre><p>We configure deploy arguments in the <code>extra_args</code> variable, so for the
above configuration we would add:</p><pre><code>extra_args: &gt;
  --control-scale 3
  -e /usr/share/openstack-tripleo-heat-templates/environments/puppet-pacemaker.yaml
  --ntp-server pool.ntp.org
</code></pre><h3 id=configuring-nested-kvm>Configuring nested KVM<a href=#configuring-nested-kvm class=hanchor arialabel=Anchor>&#8983;</a></h3><p>I want <a href=https://www.kernel.org/doc/Documentation/virtual/kvm/nested-vmx.txt>nested KVM</a> on my compute hosts,
which requires changes both to the libvirt XML used to deploy the
&ldquo;baremetal&rdquo; hosts and the nova.conf configuration. I was able to
accomplish this by adding the following to the configuration:</p><pre><code>baremetal_vm_xml: |
  &lt;cpu mode='host-passthrough'/&gt;
libvirt_args: --libvirt-type kvm
</code></pre><p>For this to work, you will need to have your target host correctly
configured to support nested KVM, which generally means adding the
following to <code>/etc/modprobe.d/kvm.conf</code>:</p><pre><code>options kvm_intel nested=1
</code></pre><p>(And possibly unloading/reloading the <code>kvm_intel</code> module if it was
already loaded.)</p><h3 id=disable-some-steps>Disable some steps<a href=#disable-some-steps class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The default behavior is to:</p><ul><li>Install the undercloud</li><li>Deploy the overcloud</li><li>Validate the overcloud</li></ul><p>You can enable or disable individual steps with the following
variables:</p><ul><li><code>step_install_undercloud</code></li><li><code>step_deploy_overcloud</code></li><li><code>step_validate_overcloud</code></li></ul><p>These all default to <code>true</code>. If, for example, overcloud validation is
failing because of a known issue, we could add the following to
<code>nodes.yml</code>:</p><pre><code>step_validate_overcloud: false
</code></pre><h2 id=pre-caching-the-undercloud-image>Pre-caching the undercloud image<a href=#pre-caching-the-undercloud-image class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Fetching the undercloud image from the CentOS CI environment can take
a really long time. If you&rsquo;re going to be deploying often, you can
speed up this step by manually saving the image and the corresponding
<code>.md5</code> file to a file on your target host:</p><pre><code>mkdir -p /usr/share/quickstart_images/mitaka/
cd /usr/share/quickstart_images/mitaka/
wget https://ci.centos.org/artifacts/rdo/images/mitaka/delorean/stable/undercloud.qcow2.md5 \
  https://ci.centos.org/artifacts/rdo/images/mitaka/delorean/stable/undercloud.qcow2
</code></pre><p>And then providing the path to that file in the <code>url</code> variable when
you run the playbook. I&rsquo;ve added the following to my <code>nodes.yml</code>
file, but you could also do this on the command line:</p><pre><code>url: file:///usr/share/quickstart_images/mitaka/undercloud.qcow2
</code></pre><h2 id=intermission>Intermission<a href=#intermission class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I&rsquo;ve made the examples presented in this article available for
download at the following URLs:</p><ul><li><a href=ha.yml>ha.yml</a> playbook</li><li><a href=nodes.yml>nodes.yml</a> example configuration file</li><li><a href=nodes-minimal.yml>nodes-minimal.yml</a> example configuration file for a minimal environment</li></ul><h2 id=running-tripleo-quickstart>Running tripleo-quickstart<a href=#running-tripleo-quickstart class=hanchor arialabel=Anchor>&#8983;</a></h2><p>With all of the above in place, we can run:</p><pre><code>ansible-playbook ha.yml -i inventory -e @nodes.yml
</code></pre><p>Which will proceed through the following phases:</p><h3 id=tear-down-existing-environment>Tear down existing environment<a href=#tear-down-existing-environment class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This step deletes any libvirt guests matching the ones we are about to
deploy, removes the <code>stack</code> user from the target host, and otherwise
ensures a clean slate from which to start.</p><h3 id=create-overcloud-vms>Create overcloud vms<a href=#create-overcloud-vms class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This uses the node definitions in <code>vm.overcloud.nodes</code> to create a set
of libvirt guests. They will <em>not</em> be booted at this stage; that
happens later during the ironic discovery process.</p><h3 id=fetch-the-undercloud-image>Fetch the undercloud image<a href=#fetch-the-undercloud-image class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This will fetch the undercloud appliance image either from the CentOS
CI environment or from wherever you point the <code>url</code> variable.</p><h3 id=configure-the-undercloud-image>Configure the undercloud image<a href=#configure-the-undercloud-image class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This performs some initial configuration steps such as injecting ssh
keys into the image.</p><h3 id=create-undercloud-vm>Create undercloud vm<a href=#create-undercloud-vm class=hanchor arialabel=Anchor>&#8983;</a></h3><p>In this step, tripleo-quickstart uses the configured appliance image
to create a new <code>undercloud</code> libvirt guest.</p><h3 id=install-undercloud>Install undercloud<a href=#install-undercloud class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This runs <code>openstack undercloud install</code>.</p><h3 id=deploy-overcloud>Deploy overcloud<a href=#deploy-overcloud class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This does everything else:</p><ul><li>Discover the available nodes via the Ironic discovery process</li><li>Use <code>openstack overcloud deploy</code> to kick off the provisioning
process. This feeds <a href=https://wiki.openstack.org/wiki/Heat>Heat</a> a collection of templates that will be
used to configure the overcloud nodes.</li></ul><h2 id=accessing-the-undercloud>Accessing the undercloud<a href=#accessing-the-undercloud class=hanchor arialabel=Anchor>&#8983;</a></h2><p>You can ssh directly into the undercloud host by taking advantage of
the ssh configuration that tripleo-quickstart generated for you. By
default this will be <code>$HOME/.quickstart/ssh.config.ansible</code>, but you
can override that directory by specifying a value for the
<code>local_working_dir</code> variable when you run Ansible. You use the <code>-F</code>
option to ssh to point it at that file:</p><pre><code>ssh -F $HOME/.quickstart/ssh.config.ansible undercloud
</code></pre><p>The configuration uses an ssh <code>ProxyConnection</code> configuration to
automatically proxy your connection to the undercloud vm through your
physical host.</p><h2 id=accessing-the-overcloud-hosts>Accessing the overcloud hosts<a href=#accessing-the-overcloud-hosts class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Once you have logged into the undercloud, you&rsquo;ll need to source in
some credentials. The file <code>stackrc</code> contains credentials for the
undercloud:</p><pre><code>. stackrc
</code></pre><p>Now you can run <code>nova list</code> to get a list of your overcloud nodes,
investigate the <code>overcloud</code> heat stack, and so forth:</p><pre><code>$ heat stack-list
+----------...+------------+-----------------+--------------...+--------------+
| id       ...| stack_name | stack_status    | creation_time...| updated_time |
+----------...+------------+-----------------+--------------...+--------------+
| b6cfd621-...| overcloud  | CREATE_COMPLETE | 2016-02-19T20...| None         |
+----------...+------------+-----------------+--------------...+--------------+
</code></pre><p>You can find the ip addresses of your overcloud nodes by running <code>nova list</code>:</p><pre><code>$ nova list
+----------...+-------------------------+--------+...+---------------------+
| ID       ...| Name                    | Status |...| Networks            |
+----------...+-------------------------+--------+...+---------------------+
| 1fc5d5e8-...| overcloud-controller-0  | ACTIVE |...| ctlplane=192.0.2.9  |
| ab6439e8-...| overcloud-controller-1  | ACTIVE |...| ctlplane=192.0.2.10 |
| 82e12f81-...| overcloud-controller-2  | ACTIVE |...| ctlplane=192.0.2.11 |
| 53402a35-...| overcloud-novacompute-0 | ACTIVE |...| ctlplane=192.0.2.8  |
+----------...+-------------------------+--------+...+---------------------+
</code></pre><p>You&rsquo;ll use the <code>ctlplane</code> address to log into each host as the
<code>heat-admin</code> user. For example, to log into my compute host:</p><pre><code>$ ssh heat-admin@192.0.2.8
</code></pre><h2 id=accessing-the-overcloud-openstack-environment>Accessing the overcloud OpenStack environment<a href=#accessing-the-overcloud-openstack-environment class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The file <code>overcloudrc</code> on the undercloud host has administrative
credentials for the overcloud environment:</p><pre><code>. overcloudrc
</code></pre><p>After sourcing in the overcloud credentials you can use OpenStack
clients to interact with your deployed cloud environment.</p><h2 id=if-you-find-bugs>If you find bugs<a href=#if-you-find-bugs class=hanchor arialabel=Anchor>&#8983;</a></h2><p>If anything in the above process doesn&rsquo;t work as described or
expected, feel free to visit the <code>#rdo</code> channel on <a href=https://freenode.net/>freenode</a>, or
open a bug report on the <a href=https://github.com/redhat-openstack/tripleo-quickstart/issues>issue tracker</a>.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script>
<script src=/js/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>