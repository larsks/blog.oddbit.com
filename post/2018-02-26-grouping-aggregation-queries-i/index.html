<!doctype html><html lang=en><head><title>Grouping aggregation queries in Gnocchi 4.0.x :: blog.oddbit.com</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this article, we&amp;rsquo;re going to ask Gnocchi (the OpenStack telemetry storage service) how much memory was used, on average, over the course of each day by each project in an OpenStack environment.
Environment I&amp;rsquo;m working with an OpenStack &amp;ldquo;Pike&amp;rdquo; deployment, which means I have Gnocchi 4.0.x. More recent versions of Gnocchi (4.1.x and later) have a new aggregation API called dynamic aggregates, but that isn&amp;rsquo;t available in 4.0.x so in this article we&amp;rsquo;ll be using the legacy /v1/aggregations API."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2018-02-26-grouping-aggregation-queries-i/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG")}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Grouping aggregation queries in Gnocchi 4.0.x"><meta property="og:description" content="In this article, we&amp;rsquo;re going to ask Gnocchi (the OpenStack telemetry storage service) how much memory was used, on average, over the course of each day by each project in an OpenStack environment.
Environment I&amp;rsquo;m working with an OpenStack &amp;ldquo;Pike&amp;rdquo; deployment, which means I have Gnocchi 4.0.x. More recent versions of Gnocchi (4.1.x and later) have a new aggregation API called dynamic aggregates, but that isn&amp;rsquo;t available in 4.0.x so in this article we&amp;rsquo;ll be using the legacy /v1/aggregations API."><meta property="og:url" content="https://blog.oddbit.com/post/2018-02-26-grouping-aggregation-queries-i/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2018-02-26 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2018-02-26-grouping-aggregation-queries-i/>Grouping aggregation queries in Gnocchi 4.0.x</a></h1><div class=post-meta><time class=post-date>2018-02-26 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/openstack/>openstack</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/gnocchi/>gnocchi</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/metrics/>metrics</a>&nbsp;</span><div class=post-content><div><p>In this article, we&rsquo;re going to ask Gnocchi (the OpenStack telemetry
storage service) how much memory was used, on average, over the course
of each day by each project in an OpenStack environment.</p><h2 id=environment>Environment<a href=#environment class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I&rsquo;m working with an OpenStack &ldquo;Pike&rdquo; deployment, which means I have
Gnocchi 4.0.x. More recent versions of Gnocchi (4.1.x and later) have
a new aggregation API called <a href=https://gnocchi.xyz/rest.html#dynamic-aggregates>dynamic aggregates</a>, but that isn&rsquo;t
available in 4.0.x so in this article we&rsquo;ll be using the legacy
<code>/v1/aggregations</code> API.</p><h2 id=the-gnocchi-data-model>The Gnocchi data model<a href=#the-gnocchi-data-model class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In Gnocchi, named metrics are associated with <em>resources</em>. A
<em>resource</em> corresponds to an object in OpenStack, such as a Nova
instance, or a Neutron network, etc. Metrics on a resource are
created dynamically and depend entirely on which metrics you are
collecting with Ceilometer and delivering to Gnocchi, and two
different resources of the same resource type may have different sets
of metrics.</p><p>The list of metrics available from OpenStack is available in the
<a href=https://docs.openstack.org/ceilometer/latest/admin/telemetry-measurements.html>telemetry documentation</a>. The <a href=https://docs.openstack.org/ceilometer/latest/admin/telemetry-measurements.html#openstack-compute>metrics available for Nova
servers</a> include statistics on cpu utilization,
memory utilization, disk read/write operations, network traffic, and
more.</p><p>In this example, we&rsquo;re going to look at the <code>memory.usage</code> metric.</p><h2 id=building-a-query>Building a query<a href=#building-a-query class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The amount of memory used is available in the <code>memory.usage</code> metric
associated with each <code>instance</code> resource. We&rsquo;re using the legacy
<code>/v1/aggregations</code> API, so the request url will initially look like:</p><pre><code>/v1/aggregation/resource/instance/metric/memory.usage
</code></pre><p>We need to specify which granularity we want to fetch. We&rsquo;re using
the <code>low</code> archive policy from the default Gnocchi configuration which
means we only have one option (metrics are aggregated into 5 minute
intervals). We use the <code>granularity</code> parameter to tell Gnocchi which
granularity we want:</p><pre><code>.../metric/memory.usage?granularity=300
</code></pre><p>We want the average utilization, so that means:</p><pre><code>.../metric/memory.usage?granularity=300&amp;aggregation=mean
</code></pre><p>We&rsquo;d like to limit this to the past 30 days of data, so we&rsquo;ll add an
appropriate <code>start</code> parameter. There are various ways of specifying
time in Gnocchi, documented in the <a href=https://gnocchi.xyz/rest.html#timestamp-format>Timestamps</a> section of the docs.
Specifying &ldquo;30 days ago&rdquo; is as simple as: <code>start=-30+days</code>. So our
request now looks like:</p><pre><code>.../metric/memory.usage?granularity=300&amp;aggregation=mean&amp;start=-30+days
</code></pre><p>We have values at 5 minute intervals, but we would like daily
averages, so we&rsquo;ll need to use the <a href=https://gnocchi.xyz/rest.html#resample>resample</a> parameter to ask
Gnocchi to reshape the data for us. The argument to <code>resample</code> is a
time period specified as a number of seconds; since we want daily
averages, that means <code>resample=86400</code>:</p><pre><code>.../metric/memory.usage?granularity=300&amp;aggregation=mean&amp;start=-30+days&amp;resample=86400
</code></pre><p>We want to group the results by project, which means we&rsquo;ll need the
<code>groupby</code> parameter. Instances (and most other resources) store this
information in the <code>project_id</code> attribute, so <code>groupby=project_id</code>:</p><pre><code>.../metric/memory.usage?granularity=300&amp;aggregation=mean&amp;start=-30+days&amp;resample=86400&amp;groupby=project_id
</code></pre><p>Lastly, not all metrics will have measurements covering the same
period. If we were to try the query as we have it right now, we would
probably see:</p><pre><code>400 Bad Request

The server could not comply with the request since it is either
malformed or otherwise incorrect.

One of the metrics being aggregated doesn't have matching
granularity: Metrics &lt;list of metrics here&gt;...can't be aggregated:
No overlap
</code></pre><p>Gnocchi provides a <code>fill</code> parameter to indicate what should happen
with missing data. In Gnocchi 4.0.x, the options are <code>fill=0</code>
(replace missing data with <code>0</code>) and <code>fill=null</code> (compute the
aggregation using only available data points). Selecting <code>fill=0</code> gets
us:</p><pre><code>.../metric/memory.usage?granularity=300&amp;aggregation=mean&amp;start=-30+days&amp;resample=86400&amp;groupby=project_id&amp;fill=0
</code></pre><p>That should give us the results we want. The return value from that
query looks something like this:</p><pre><code>[
    {
        &quot;group&quot;: {
            &quot;project_id&quot;: &quot;00a8d5e942bb442b86733f0f92280fcc&quot;
        },
        &quot;measures&quot;: [
            [
                &quot;2018-02-14T00:00:00+00:00&quot;,
                86400.0,
                2410.014338235294
            ],
            [
                &quot;2018-02-15T00:00:00+00:00&quot;,
                86400.0,
                2449.4921970791206
            ],
            .
            .
            .
    {
        &quot;group&quot;: {
            &quot;project_id&quot;: &quot;03d2a1de5b2342d78d14e5294a81e0b0&quot;
        },
        &quot;measures&quot;: [
            [
                &quot;2018-02-14T00:00:00+00:00&quot;,
                86400.0,
                381.0
            ],
            [
                &quot;2018-02-15T00:00:00+00:00&quot;,
                86400.0,
                380.99004975124376
            ],
            [
                &quot;2018-02-16T00:00:00+00:00&quot;,
                86400.0,
                380.99305555555554
            ],
            .
            .
            .
</code></pre><h2 id=authenticating-to-gnocchi>Authenticating to Gnocchi<a href=#authenticating-to-gnocchi class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Since we&rsquo;re using Gnocchi as part of an OpenStack deployment, we&rsquo;ll
be authenticating to Gnocchi using a Keystone token. Let&rsquo;s take a
look at how you could do that from the command line using <code>curl</code>.</p><h3 id=acquiring-a-token>Acquiring a token<a href=#acquiring-a-token class=hanchor arialabel=Anchor>&#8983;</a></h3><p>You can acquire a token using the <code>openstack token issue</code> command,
which will produce output like:</p><pre><code>+------------+------------------------------------------------------------------------+
| Field      | Value                                                                  |
+------------+------------------------------------------------------------------------+
| expires    | 2018-02-26T23:09:36+0000                                               |
| id         | ...                                                                    |
| project_id | c53c18b2d29641e0877bbbd8d87f8267                                       |
| user_id    | 533ad9ab4fed403fb98f1ffc2f2b4436                                       |
+------------+------------------------------------------------------------------------+
</code></pre><p>While it is possible to parse that with, say, <code>awk</code>, it&rsquo;s not
really designed to be machine readable. We can get just the token
value by instead calling:</p><pre><code>openstack token issue -c id -f value
</code></pre><p>We should probably store that in a variable:</p><pre><code>TOKEN=$(openstack token issue -c id -f value)
</code></pre><h3 id=querying-gnocchi>Querying Gnocchi<a href=#querying-gnocchi class=hanchor arialabel=Anchor>&#8983;</a></h3><p>In order to make our command line shorter, let&rsquo;s set <code>ENDPOINT</code> to the
URL of our Gnocchi endpoint:</p><pre><code>ENDPOINT=http://cloud.example.com:8041/v1
</code></pre><p>We&rsquo;ll pass the Keystone token in the <code>X-Auth-Token</code> header. Gnocchi
is expecting a JSON document body as part of this request (you can use
that to specify a filter; see the <a href=https://gnocchi.xyz/rest.html>API documentation</a> for details),
so we need to both set a <code>Content-type</code> header and provide at least an
empty JSON object. That makes our final request look like:</p><pre><code>curl \
  -H &quot;X-Auth-Token: $TOKEN&quot; \
  -H &quot;Content-type: application/json&quot; \
  -d &quot;{}&quot; \
  &quot;$ENDPOINT/aggregation/resource/instance/metric/memory.usage?granularity=300&amp;aggregation=mean&amp;start=-30+days&amp;resample=86400&amp;groupby=project_id&amp;fill=0&quot;
</code></pre></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>