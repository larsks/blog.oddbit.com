<!doctype html><html lang=en><head><title>Ansible for Infrastructure Testing :: blog.oddbit.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="At $JOB we often find ourselves at customer sites where we see the same set of basic problems that we have previously encountered elsewhere (&ldquo;your clocks aren&rsquo;t in sync&rdquo; or &ldquo;your filesystem is full&rdquo; or &ldquo;you haven&rsquo;t installed a critical update&rdquo;, etc). We would like a simple tool that could be run either by the customer or by our own engineers to test for and report on these common issues. Fundamentally, we want something that acts like a typical code test suite, but for infrastructure.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2017-08-02-ansible-for-infrastructure-tes/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG")}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Ansible for Infrastructure Testing"><meta property="og:description" content="At $JOB we often find ourselves at customer sites where we see the same set of basic problems that we have previously encountered elsewhere (&ldquo;your clocks aren&rsquo;t in sync&rdquo; or &ldquo;your filesystem is full&rdquo; or &ldquo;you haven&rsquo;t installed a critical update&rdquo;, etc). We would like a simple tool that could be run either by the customer or by our own engineers to test for and report on these common issues. Fundamentally, we want something that acts like a typical code test suite, but for infrastructure.
"><meta property="og:url" content="https://blog.oddbit.com/post/2017-08-02-ansible-for-infrastructure-tes/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2017-08-02 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2017-08-02-ansible-for-infrastructure-tes/>Ansible for Infrastructure Testing</a></h1><div class=post-meta><time class=post-date>2017-08-02 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/ansible/>ansible</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/ansible-assertive/>ansible-assertive</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/openstack/>openstack</a>&nbsp;</span><div class=post-content><div><p>At <code>$JOB</code> we often find ourselves at customer sites where we see the
same set of basic problems that we have previously encountered
elsewhere (&ldquo;your clocks aren&rsquo;t in sync&rdquo; or &ldquo;your filesystem is full&rdquo;
or &ldquo;you haven&rsquo;t installed a critical update&rdquo;, etc). We would like a
simple tool that could be run either by the customer or by our own
engineers to test for and report on these common issues.
Fundamentally, we want something that acts like a typical code test
suite, but for infrastructure.</p><p>It turns out that Ansible is <em>almost</em> the right tool for the job:</p><ul><li>It&rsquo;s easy to write simple tests.</li><li>It works well in distributed environments.</li><li>It&rsquo;s easy to extend with custom modules and plugins.</li></ul><p>The only real problem is that Ansible has, by default, &ldquo;fail fast&rdquo;
behavior: once a task fails on a host, no more tasks will run on that
host. That&rsquo;s great if you&rsquo;re actually making configuration changes,
but for our purposes we are running a set of read-only independent
checks, and we want to know the success or failure of all of those
checks in a single operation (and in many situations we may not have
the option of correcting the underlying problem ourselves).</p><p>In this post, I would like to discuss a few Ansible extensions I&rsquo;ve
put together to make it more useful as an infrastructure testing tool.</p><h2 id=the-ansible-assertive-project>The ansible-assertive project<a href=#the-ansible-assertive-project class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The <a href=https://github.com/larsks/ansible-assertive/>ansible-assertive</a> project contains two extensions for Ansible:</p><ul><li><p>The <code>assert</code> action plugin replaces Ansible&rsquo;s native <code>assert</code>
behavior with something more appropriate for infrastructure testing.</p></li><li><p>The <code>assertive</code> callback plugin modifies the output of <code>assert</code>
tasks and collects and reports results.</p></li></ul><p>The idea is that you write all of your tests using the <code>assert</code>
plugin, which means you can run your playbooks in a stock environment
and see the standard Ansible fail-fast behavior, or you can activate
the <code>assert</code> plugin from the ansible-assertive project and get
behavior more useful for infrastructure testing.</p><h2 id=a-simple-example>A simple example<a href=#a-simple-example class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Ansible&rsquo;s native <code>assert</code> plugin will trigger a task failure when an
assertion evaluates to <code>false</code>. Consider the following example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>fruits</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>oranges</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>lemons</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>assert</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>that</span>: &gt;-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#39;apples&#39; in fruits</span>          
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#ae81ff>you have no apples</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>assert</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>that</span>: &gt;-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#39;lemons&#39; in fruits</span>          
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#ae81ff>you have no lemons</span>
</span></span></code></pre></div><p>If we run this in a stock Ansible environment, we will see the
following:</p><pre tabindex=0><code>PLAY [localhost] ***************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [assert] ******************************************************************
fatal: [localhost]: FAILED! =&gt; {
    &#34;assertion&#34;: &#34;&#39;apples&#39; in fruits&#34;,
    &#34;changed&#34;: false,
    &#34;evaluated_to&#34;: false,
    &#34;failed&#34;: true,
    &#34;msg&#34;: &#34;you have no apples&#34;
}
	to retry, use: --limit @/home/lars/projects/ansible-assertive/examples/ex-005/playbook1.retry

PLAY RECAP *********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=1
</code></pre><h2 id=a-modified-assert-plugin>A modified assert plugin<a href=#a-modified-assert-plugin class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Let&rsquo;s activate the <code>assert</code> plugin in <a href=https://github.com/larsks/ansible-assertive/>ansible-assertive</a>. We&rsquo;ll
start by cloning the project into our local directory:</p><pre><code>$ git clone https://github.com/larsks/ansible-assertive
</code></pre><p>And we&rsquo;ll activate the plugin by creating an <code>ansible.cfg</code> file with
the following content:</p><pre><code>[defaults]
action_plugins = ./ansible-assertive/action_plugins
</code></pre><p>Now when we re-run the playbook we see that a failed assertion now
registers as <code>changed</code> rather than <code>failed</code>:</p><pre tabindex=0><code>PLAY [localhost] ***************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [assert] ******************************************************************
changed: [localhost]

TASK [assert] ******************************************************************
ok: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=3    changed=1    unreachable=0    failed=0
</code></pre><p>While that doesn&rsquo;t look like much of a change, there are two things of
interest going on here. The first is that the <code>assert</code> plugin
provides detailed information about the assertions specified in the
task; if we were to <code>register</code> the result of the failed assertion and
display it in a <code>debug</code> task, it would look like:</p><pre tabindex=0><code>TASK [debug] *******************************************************************
ok: [localhost] =&gt; {
    &#34;apples&#34;: {
        &#34;ansible_stats&#34;: {
            &#34;aggregate&#34;: true,
            &#34;data&#34;: {
                &#34;assertions&#34;: 1,
                &#34;assertions_failed&#34;: 1,
                &#34;assertions_passed&#34;: 0
            },
            &#34;per_host&#34;: true
        },
        &#34;assertions&#34;: [
            {
                &#34;assertion&#34;: &#34;&#39;apples&#39; in fruits&#34;,
                &#34;evaluated_to&#34;: false
            }
        ],
        &#34;changed&#34;: true,
        &#34;failed&#34;: false,
        &#34;msg&#34;: &#34;you have no apples&#34;
    }
}
</code></pre><p>The <code>assertions</code> key in the result dictionary contains of a list of
tests and their results. The <code>ansible_stats</code> key contains metadata
that will be consumed by the custom statistics support in recent
versions of Ansible. If you have Ansible 2.3.0.0 or later, add
the following to the <code>defaults</code> section of your <code>ansible.cfg</code>:</p><pre tabindex=0><code>show_custom_stats = yes
</code></pre><p>With this feature enabled, your playbook run will conclude with:</p><pre tabindex=0><code>CUSTOM STATS: ******************************************************************
	localhost: { &#34;assertions&#34;: 2,  &#34;assertions_failed&#34;: 1,  &#34;assertions_passed&#34;: 1}
</code></pre><h2 id=a-callback-plugin-for-better-output>A callback plugin for better output<a href=#a-callback-plugin-for-better-output class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The <code>assertive</code> callback plugin provided by the <a href=https://github.com/larsks/ansible-assertive/>ansible-assertive</a>
project will provide more useful output concerning the result of
failed assertions. We activate it by adding the following to our
<code>ansible.cfg</code>:</p><pre><code>callback_plugins = ./ansible-assertive/callback_plugins
stdout_callback = assertive
</code></pre><p>Now when we run our playbook we see:</p><pre tabindex=0><code>PLAY [localhost] ***************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [assert] ******************************************************************
failed: [localhost]  ASSERT(&#39;apples&#39; in fruits)
failed: you have no apples

TASK [assert] ******************************************************************
passed: [localhost]  ASSERT(&#39;lemons&#39; in fruits)

PLAY RECAP *********************************************************************
localhost                  : ok=3    changed=1    unreachable=0    failed=0
</code></pre><h2 id=machine-readable-statistics>Machine readable statistics<a href=#machine-readable-statistics class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The above is nice but is still primarily human-consumable. What if we
want to collect test statistics for machine processing (maybe we want
to produce a nicely formatted report of some kind, or maybe we want to
aggregate information from multiple test runs, or maybe we want to
trigger some action in the event there are failed tests, or&mldr;)? You
can ask the <code>assertive</code> plugin to write a YAML format document with
this information by adding the following to your <code>ansible.cfg</code>:</p><pre><code>[assertive]
results = testresult.yml
</code></pre><p>After running our playbook, this file would contain:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>localhost</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>stats</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>assertions</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>assertions_failed</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>assertions_passed</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>assertions_skipped</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>tests</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>assertions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>test</span>: <span style=color:#e6db74>&#39;&#39;&#39;apples&#39;&#39; in fruits&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>testresult</span>: <span style=color:#ae81ff>failed</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#ae81ff>you have no apples</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>testresult</span>: <span style=color:#ae81ff>failed</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>testtime</span>: <span style=color:#e6db74>&#39;2017-08-04T21:20:58.624789&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>assertions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>test</span>: <span style=color:#e6db74>&#39;&#39;&#39;lemons&#39;&#39; in fruits&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>testresult</span>: <span style=color:#ae81ff>passed</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#ae81ff>All assertions passed</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>testresult</span>: <span style=color:#ae81ff>passed</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>testtime</span>: <span style=color:#e6db74>&#39;2017-08-04T21:20:58.669144&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stats</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>assertions</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>assertions_failed</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>assertions_passed</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>assertions_skipped</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>stats</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>assertions</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>assertions_failed</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>assertions_passed</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>assertions_skipped</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>timing</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>test_finished_at</span>: <span style=color:#e6db74>&#39;2017-08-04T21:20:58.670802&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>test_started_at</span>: <span style=color:#e6db74>&#39;2017-08-04T21:20:57.918412&#39;</span>
</span></span></code></pre></div><p>With these tools it becomes much easier to design playbooks for
testing your infrastructure.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>