<!doctype html><html lang=en><head><title>Ansible 2.0: New OpenStack modules :: blog.oddbit.com</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is the second in a loose sequence of articles looking at new features in Ansible 2.0. In the previous article I looked at the Docker connection driver. In this article, I would like to provide an overview of the new-and-much-improved suite of modules for interacting with an OpenStack environment, and provide a few examples of their use.
In versions of Ansible prior to 2.0, there was a small collection of OpenStack modules."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2015-10-26-ansible-20-new-openstack-modul/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Ansible 2.0: New OpenStack modules"><meta property="og:description" content="This is the second in a loose sequence of articles looking at new features in Ansible 2.0. In the previous article I looked at the Docker connection driver. In this article, I would like to provide an overview of the new-and-much-improved suite of modules for interacting with an OpenStack environment, and provide a few examples of their use.
In versions of Ansible prior to 2.0, there was a small collection of OpenStack modules."><meta property="og:url" content="https://blog.oddbit.com/post/2015-10-26-ansible-20-new-openstack-modul/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2015-10-26 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2015-10-26-ansible-20-new-openstack-modul/>Ansible 2.0: New OpenStack modules</a></h1><div class=post-meta><time class=post-date>2015-10-26 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/ansible/>ansible</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/openstack/>openstack</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/ansible_20_series/>ansible_20_series</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/pull-request/>pull-request</a>&nbsp;</span><div class=post-content><div><p>This is the second in a loose sequence of articles looking at new
features in Ansible 2.0. In the previous article I looked at the
<a href=https://blog.oddbit.com/post/2015-10-13-ansible-20-the-docker-connecti/>Docker connection driver</a>. In this article, I would like to
provide an overview of the new-and-much-improved suite of modules for
interacting with an <a href=http://www.openstack.org/>OpenStack</a> environment, and provide a few
examples of their use.</p><p>In versions of Ansible prior to 2.0, there was a small collection of
OpenStack modules. There was the minimum necessary to boot a Nova
instance:</p><ul><li><code>glance_image.py</code></li><li><code>keystone_user.py</code></li><li><code>nova_compute.py</code></li><li><code>nova_keypair.py</code></li></ul><p>And a collection of modules for interacting with <a href=https://wiki.openstack.org/wiki/Neutron>Neutron</a> (previously
Quantum):</p><ul><li><code>quantum_floating_ip_associate.py</code></li><li><code>quantum_floating_ip.py</code></li><li><code>quantum_network.py</code></li><li><code>quantum_router_gateway.py</code></li><li><code>quantum_router_interface.py</code></li><li><code>quantum_router.py</code></li><li><code>quantum_subnet.py</code></li></ul><p>While functional, these modules did not provide very comprehensive
coverage of even basic OpenStack services, and they suffered from
having a great deal of duplicated code (which made ensuring
consistent behavior across all the modules more difficult). The
behavior of these modules was not always what you would expect (e.g.,
the <code>nova_compute</code> module would return information in different forms
depending on whether it had to create an instance or not).</p><h2 id=throwing-shade>Throwing Shade<a href=#throwing-shade class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The situation is much improved in Ansible 2.0, which introduces a new
suite of OpenStack modules in which the common code has been factored
out into the <a href=https://pypi.python.org/pypi/shade>Shade</a> project, a Python package that provides a
simpler interface to OpenStack than is available using the native
clients. Collecting this code in one place will help ensure both that
these Ansible modules share consistent behavior and that they are
easier to maintain.</p><p>There are modules for managing Keystone:</p><ul><li><code>os_auth.py</code></li><li><code>os_user_group.py</code></li><li><code>os_user.py</code></li></ul><p>Glance:</p><ul><li><code>os_image_facts.py</code></li><li><code>os_image.py</code></li></ul><p>Cinder:</p><ul><li><code>os_server_volume.py</code></li><li><code>os_volume.py</code></li></ul><p>Nova:</p><ul><li><code>os_keypair.py</code></li><li><code>os_nova_flavor.py</code></li><li><code>os_server_actions.py</code></li><li><code>os_server_facts.py</code></li><li><code>os_server.py</code></li></ul><p>Ironic:</p><ul><li><code>os_ironic_node.py</code></li><li><code>os_ironic.py</code></li></ul><p>Neutron and Nova Networking:</p><ul><li><code>os_floating_ip.py</code></li><li><code>os_network.py</code></li><li><code>os_networks_facts.py</code></li><li><code>os_port.py</code></li><li><code>os_router.py</code></li><li><code>os_security_group.py</code></li><li><code>os_security_group_rule.py</code></li><li><code>os_subnet.py</code></li><li><code>os_subnets_facts.py</code></li></ul><p>and Swift:</p><ul><li><code>os_object.py</code></li></ul><h2 id=authentication>Authentication<a href=#authentication class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Shade uses the <a href=https://pypi.python.org/pypi/os-client-config/>os-client-config</a> library to configure
authentication credentials for your OpenStack environment.</p><p>In the absence of any authentication information provided in your
Ansible playbook, these modules will attempt to use the standard suite
of <code>OS_*</code> variables (<code>OS_USERNAME</code>, <code>OS_PASSWORD</code>, etc). This is fine
for testing, but you usually want to provide some sort of
authentication configuration in your Ansible environment.</p><p>You can provide credentials directly in your plays by providing an
<code>auth</code> argument to any of the modules. For example:</p><pre><code>- os_image:
    auth:
      auth_url: http://openstack.local:5000/v2.0
      username: admin
      password: secret
      project_name: admin
    [...]
</code></pre><p>But that can get complicated, especially if you are maintaining
multiple sets of credentials. The <code>shade</code> library allows you to
manage credentials in a file named (by default) <code>clouds.yml</code>, which
<code>shade</code> searches for in:</p><ul><li>The current directory</li><li><code>$HOME/.config/openstack/</code></li><li><code>/etc/xdg/openstack/</code></li><li><code>/etc/openstack</code></li></ul><p>This file may contain credentials for one or more cloud environments,
for example:</p><pre><code>clouds:
  testing:
    auth:
      auth_url: http://openstack.local:5000/v2.0
      username: admin
      password: secret
      project_name: admin
</code></pre><p>If you have the above in <code>clouds.yml</code> along with your playbook, the
above <code>os_image</code> example can be rewritten as:</p><pre><code>- os_image:
    cloud: testing
    [...]
</code></pre><h2 id=return-values>Return values<a href=#return-values class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The new modules all return useful information about the objects they
have created. For example, if you create a network using
<a href=http://docs.ansible.com/ansible/os_network_module.html>os_network</a> and register that result:</p><pre><code>- os_network:
    cloud: testing
    name: mynetwork
  register: mynetwork
</code></pre><p>You&rsquo;ll get back a dictionary containing a top-level <code>id</code> attribute,
which is the UUID of the created network, along with a <code>network</code>
attribute containing a dictionary of information about the created
object. The <a href=http://docs.ansible.com/ansible/debug_module.html>debug</a> module is an excellent tool for exploring these
return values. If we put the following in our playbook immediately
after the above task:</p><pre><code>- debug:
    var: mynetwork
</code></pre><p>We would get output that looks something like:</p><pre><code>ok: [localhost] =&gt; {
    &quot;changed&quot;: false, 
    &quot;mynetwork&quot;: {
        &quot;changed&quot;: true, 
        &quot;id&quot;: &quot;02b77e32-794a-4102-ab1b-1b90e6d4d92f&quot;, 
        &quot;invocation&quot;: {
            &quot;module_args&quot;: {
                &quot;cloud&quot;: &quot;testing&quot;, 
                &quot;name&quot;: &quot;mynetwork&quot;
            }, 
            &quot;module_name&quot;: &quot;os_network&quot;
        }, 
        &quot;network&quot;: {
            &quot;admin_state_up&quot;: true, 
            &quot;id&quot;: &quot;02b77e32-794a-4102-ab1b-1b90e6d4d92f&quot;, 
            &quot;mtu&quot;: 0, 
            &quot;name&quot;: &quot;mynetwork&quot;, 
            &quot;provider:network_type&quot;: &quot;vxlan&quot;, 
            &quot;provider:physical_network&quot;: null, 
            &quot;provider:segmentation_id&quot;: 79, 
            &quot;router:external&quot;: false, 
            &quot;shared&quot;: false, 
            &quot;status&quot;: &quot;ACTIVE&quot;, 
            &quot;subnets&quot;: [], 
            &quot;tenant_id&quot;: &quot;349a8b95c5ad4a3383149f65f8c44cff&quot;
        }
    }
}
</code></pre><h2 id=examples>Examples<a href=#examples class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I have written a set of basic <a href=https://github.com/ansible/ansible/pull/12875>integration tests</a> for these modules.
I hope the pull request is merged, but even if not it provides an
example of how to make use of many of these new modules.</p><p>I&rsquo;d like to present a few brief examples here to give you a sense of
what working with the new modules is like.</p><h3 id=uploading-an-image-to-glance>Uploading an image to Glance<a href=#uploading-an-image-to-glance class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The <a href=http://docs.ansible.com/ansible/os_image_module.html>os_image</a> module is used to upload an image to Glance. Assuming
that you have file named <code>cirros.qcow2</code> available locally, this will
create an image named <code>cirros</code> in Glance:</p><pre><code>- os_image:
    cloud: testing
    name: cirros
    state: present
    disk_format: qcow2
    container_format: bare
    filename: cirros.qcow2
</code></pre><h3 id=booting-a-nova-server>Booting a Nova server<a href=#booting-a-nova-server class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The <a href=http://docs.ansible.com/ansible/os_server_module.html>os_server</a> module, which is used for booting virtual servers
(&ldquo;instances&rdquo;) in Nova, replaces the <a href=http://docs.ansible.com/ansible/nova_compute_module.html>nova_compute</a> module available
in Ansible versions before 2.0:</p><pre><code>- name: create a nova server
  os_server:
    cloud: testing
    name: myserver
    state: present
    nics:
      - net-name: private
    image: cirros
    flavor: m1.small
    key_name: my_ssh_key
</code></pre><p>The <code>nics</code> parameter can accept net names, net ids, port names, and
port ids. So you could also do this (assuming you were attaching your
server to two different tenant networks):</p><pre><code>nics:
  - net-id: c875770c-a20b-45b5-a9da-5aca97153053
  - net-name: private
</code></pre><p>The above examples are using a YAML list of dictionaries to provide
the information. You can also pass in a comma-delimited key=value
string, like this:</p><pre><code>nics: net-name=private,net-name=database
</code></pre><p>This syntax is particular useful if you are running ad-hoc commands on
the command line:</p><pre><code>ansible localhost -m os_server -a '
  cloud=testing name=myserver nics=net-name=private
  image=cirros flavor=m1.small key_name=my_ssh_key'
</code></pre><h3 id=adding-a-nova-server-to-your-ansible-inventory>Adding a Nova server to your Ansible inventory<a href=#adding-a-nova-server-to-your-ansible-inventory class=hanchor arialabel=Anchor>&#8983;</a></h3><p>I&rsquo;d like to conclude this post with a longer example, that
demonstrates how you can use the <a href=http://docs.ansible.com/ansible/add_host_module.html>add_host</a> module to add a freshly
created server to your inventory, and then target that new server in
your playbook. I&rsquo;ve split up this playbook with commentary; in
practice, the pre-formatted text in this section would all be in a
single playbook (like <a href=/post/2015-10-26-ansible-20-new-openstack-modul/playbook.yml>this</a>).</p><pre><code>- hosts: localhost
  tasks:                                                                    
</code></pre><p>This first task boots the server. The values for <code>image</code>, <code>nics</code>, and
`key_name will need to be adjusted for your environment.</p><pre><code>    - os_server:
        cloud: testing
        name: myserver
        image: centos-7-atomic
        nics:
          - net-name: private
        flavor: m1.small
        key_name: lars
        auto_ip: true
      register: myserver
</code></pre><p>This <code>debug</code> entry simply shows us what values were returned in the
<code>myserver</code> variable.</p><pre><code>    - debug:
        var: myserver
</code></pre><p>Now we add the new host to our Ansible inventory. For this to work,
you need to have assigned a floating ip to the server (either using
<code>auto_ip</code>, as in this example, or by assigning one explicitly), and
you need to be running this playbook somewhere that has a route to the
floating ip address.</p><pre><code>    - add_host:
        name: myserver
        groups: openstack
        ansible_host: &quot;{{myserver.server.public_v4}}&quot;
        ansible_user: centos
        ansible_become: true
</code></pre><p>Note that in the above play you can&rsquo;t use information from the
inventory because that new host won&rsquo;t exist in the inventory until
<em>after</em> this play completes.</p><p>We&rsquo;ll need to wait for the server to finish booting and provisioning
before we are able to target it with ansible. A typical cloud image
is configured to run <a href=https://cloudinit.readthedocs.org/en/latest/>cloud-init</a> when it boots, which will take
care of a number of initial configuration tasks, including
provisioning the ssh key we configured using <code>os_server</code>. Until this
process is complete, we won&rsquo;t have remote access to the server.</p><p>We can&rsquo;t use the <code>wait_for</code> module because that will only
check for an open port. Instead, we use a <a href=http://docs.ansible.com/ansible/playbooks_loops.html#do-until-loops>do-until loop</a> to
wait until we are able to successfully run a command on the server via
ssh.</p><pre><code>    - command: &gt;
        ssh -o BatchMode=yes
        centos@{{myserver.server.public_v4}} true
      register: result
      until: result|success
      retries: 300
      delay: 5
</code></pre><p>Now that we have added the new server to our inventory
we can target it in subsequent plays (such as this one):</p><pre><code>- hosts: myserver
  tasks:

    - service:
        name: docker
        state: running
        enabled: true
</code></pre></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>