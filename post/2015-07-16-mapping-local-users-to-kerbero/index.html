<!doctype html><html lang=en><head><title>Mapping local users to Kerberos principals with SSSD :: blog.oddbit.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I work for an organization that follows the common model of assigning people systematically generated user ids. Like most technically inclined employees of this organization, I have local accounts on my workstation that don&rsquo;t bear any relation to the generated account ids. For the most part this isn&rsquo;t a problem, except that our organization uses Kerberos to authenticate access to a variety of resources (such as the mailserver and a variety of web applications).
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2015-07-16-mapping-local-users-to-kerbero/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG")}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Mapping local users to Kerberos principals with SSSD"><meta property="og:description" content="I work for an organization that follows the common model of assigning people systematically generated user ids. Like most technically inclined employees of this organization, I have local accounts on my workstation that don&rsquo;t bear any relation to the generated account ids. For the most part this isn&rsquo;t a problem, except that our organization uses Kerberos to authenticate access to a variety of resources (such as the mailserver and a variety of web applications).
"><meta property="og:url" content="https://blog.oddbit.com/post/2015-07-16-mapping-local-users-to-kerbero/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2015-07-16 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2015-07-16-mapping-local-users-to-kerbero/>Mapping local users to Kerberos principals with SSSD</a></h1><div class=post-meta><time class=post-date>2015-07-16 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/sssd/>sssd</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/kerberos/>kerberos</a>&nbsp;</span><div class=post-content><div><p>I work for an organization that follows the common model of assigning
people systematically generated user ids. Like most technically
inclined employees of this organization, I have local accounts on my
workstation that don&rsquo;t bear any relation to the generated account ids.
For the most part this isn&rsquo;t a problem, except that our organization
uses Kerberos to authenticate access to a variety of resources (such
as the mailserver and a variety of web applications).</p><p>In the past, I&rsquo;ve gotten along by running an explicit <code>kinit lkellogg@EXAMPLE.COM</code> on the command line once in a while, and that
works, but it&rsquo;s not particularly graceful.</p><p>I&rsquo;m running Fedora, which of course ships with <a href=https://fedorahosted.org/sssd/>SSSD</a>. Two of the
neat features available through SSSD are (a) you can have it acquire a
token for you automatically when you authenticate and (b) renew that
token periodically, assuming that you have a renewable token.</p><p>There are two problems that were preventing me from taking advantage
of this service.</p><h2 id=combining-kerberos-with-local-accounts>Combining Kerberos with local accounts<a href=#combining-kerberos-with-local-accounts class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The first problem is that there is a general assumption that if you&rsquo;re
using Kerberos for authentication, you are also using some sort of
enterprise-wide identity service like LDAP. The practical evidence of
this in SSSD is that you can&rsquo;t use Kerberos as an <code>auth_provider</code> if
you are using the <code>local</code> <code>id_provider</code>. If you attempt a naive
configuration that includes the following:</p><pre><code>[domain/local]
id_provider = local
auth_provider = krb5
</code></pre><p>You&rsquo;ll get:</p><pre><code>(Thu Jul 16 22:19:44:802460 2015) [sssd] [confdb_get_domain_internal]
(0x0010): Local ID provider does not support [krb5] as an AUTH provider.
</code></pre><p>It turns out that you can work around this limitation with a &ldquo;proxy&rdquo;
identity provider. With this method, SSSD <em>proxies</em> identity requests
to an existing NSS library. This can, for example, be used to get
SSSD to interoperate with a legacy NIS environment, as in <a href=http://docs.fedoraproject.org/en-US/Fedora/15/html/Deployment_Guide/sect-SSSD_User_Guide-Domain_Configuration_Options-Configuring_a_Proxy_Domain.html#sect-SSSD-proxy-krb5>this
example</a>:</p><pre><code>[domain/PROXY_KRB5]
auth_provider = krb5
krb5_server = 192.168.1.1
krb5_realm = EXAMPLE.COM

id_provider = proxy
proxy_lib_name = nis
enumerate = true
cache_credentials = true
</code></pre><p>The <code>proxy_lib_name</code> setting identifies the particular NSS provider to
use for identity information. This would make use of the <code>nis</code> NSS
module (<code>libnss_nis.so.2</code>) for identity information while using
Kerberos for authentication.</p><p>For my own use case I want to use my local accounts for identity
information, which means I need to use the <code>files</code> NSS provider:</p><pre><code>[domain/example.com]
id_provider = proxy
proxy_lib_name = files
auth_provider = krb5
</code></pre><h2 id=mapping-a-local-username-to-a-kerberos-principal>Mapping a local username to a Kerberos principal<a href=#mapping-a-local-username-to-a-kerberos-principal class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The second problem I had been struggling with was how to map my local
username (<code>lars</code>) to the organizational Kerberos principal
(<code>lkellogg@EXAMPLE.COM</code>). I had originally been looking at solutions
involving <code>kinit</code>, but despite promising verbage in the
<a href=http://web.mit.edu/kerberos/krb5-1.12/doc/user/user_config/k5identity.html>k5identity(5</a> man page, I wasn&rsquo;t meeting with much success.</p><p>It turns out that SSSD has the <code>krb5_map_user</code> option for exactly this
purpose; the syntax looks like:</p><pre><code>krb5_map_user = &lt;local name&gt;:&lt;principal name&gt;
</code></pre><p>So, for me:</p><pre><code>krb5_map_user = lars:lkellogg
</code></pre><h2 id=automatic-ticket-renewal>Automatic ticket renewal<a href=#automatic-ticket-renewal class=hanchor arialabel=Anchor>&#8983;</a></h2><p>SSSD is able to automatically renew your Kerberos tickets for you,
provided that you&rsquo;re able to acquire a renewable ticket. You can
check for this by running <code>klist</code> and seeing if your ticket has a
<code>renew until</code> date in the future, as in the following example:</p><pre><code>Ticket cache: KEYRING:persistent:1000:krb_ccache_rOS6mR8
Default principal: lkellogg@REDHAT.COM

Valid starting       Expires              Service principal
07/17/2015 11:02:31  07/17/2015 21:02:31  krbtgt/REDHAT.COM@REDHAT.COM
  renew until 07/24/2015 11:02:31
</code></pre><p>If you meet this criteria, then you can add the following
configuration options to your domain configuration:</p><pre><code>krb5_renewable_lifetime = 7d
krb5_renew_interval = 30m
</code></pre><p>The first (<code>krb5_renewable_lifetime</code>) specifies the renewable lifetime
to request when requesting a ticket, and the second (<code>krb5_renew_interval</code>) indicates how often SSSD should check to see if the ticket should be renewed.</p><h2 id=an-example-configuration>An example configuration<a href=#an-example-configuration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>This is approximately (names of been changed to protect the innocent)
configuration that I am currently using with SSSD:</p><pre><code>[domain/default]
cache_credentials = True

[sssd]
config_file_version = 2
reconnection_retries = 3
sbus_timeout = 30
services = nss, pam
domains = example.com

[nss]
filter_groups = root
filter_users = root
reconnection_retries = 3

[pam]
reconnection_retries = 3

[domain/example.com]
id_provider = proxy
proxy_lib_name = files
enumerate = True
auth_provider = krb5
krb5_server = kerberos.example.com
krb5_realm = EXAMPLE.COM
cache_credentials = True
krb5_store_password_if_offline = True
krb5_map_user = lars:lkellogg
chpass_provider = krb5
krb5_kpasswd = kerberos.example.com
offline_credentials_expiration = 0
krb5_renewable_lifetime = 7d
krb5_renew_interval = 30m
</code></pre><h2 id=configuring-pam>Configuring PAM<a href=#configuring-pam class=hanchor arialabel=Anchor>&#8983;</a></h2><p>You&rsquo;re not done yet! Once you have SSSD configured correctly, you
need to configure your system to make use of it for authentication.
First, you&rsquo;ll want to ensure that your <code>/etc/nsswitch.conf</code> file is
configured to use SSSD. You&rsquo;ll want at least the <code>passwd</code>, <code>shadow</code>,
and <code>group</code> databases configured to use SSSD:</p><pre><code>passwd:     files sss
shadow:     files sss
group:      files sss
</code></pre><p>Next, you&rsquo;ll want configure PAM. On my system, I need to change two
configuration files:</p><ul><li><code>/etc/pam.d/system-auth</code>, which is the default for many services,
and</li><li><code>/etc/pam.d/password-auth</code>, which provides defaults for other
services, including <code>sshd</code>.</li></ul><p>In my case, both files actually end up having identical content, which
looks like this (largely cribbed from <a href=http://docs.fedoraproject.org/en-US/Fedora/15/html/Deployment_Guide/chap-SSSD_User_Guide-Setting_Up_SSSD.html>the Fedora documentation</a>):</p><pre><code>#%PAM-1.0
# This file is auto-generated.
# User changes will be destroyed the next time authconfig is run.
auth        required      pam_env.so
auth        sufficient    pam_unix.so nullok try_first_pass
auth        requisite     pam_succeed_if.so uid &gt;= 1000 quiet_success
auth        sufficient    pam_sss.so use_first_pass
auth        required      pam_deny.so

account     required      pam_unix.so
account     sufficient    pam_localuser.so
account     sufficient    pam_succeed_if.so uid &lt; 1000 quiet
account     [default=bad success=ok user_unknown=ignore] pam_sss.so
account     required      pam_permit.so

password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
password    sufficient    pam_sss.so use_authtok
password    required      pam_deny.so

session     optional      pam_keyinit.so revoke
session     required      pam_limits.so
-session     optional      pam_systemd.so
session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session     optional      pam_sss.so
session     required      pam_unix.so
</code></pre><p>Note the entries for <code>pam_sss.so</code> in each stanza.</p><h2 id=the-proof-in-the-pudding>The proof in the pudding<a href=#the-proof-in-the-pudding class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I start on my local system with no Kerberos tickets:</p><pre><code>$ klist
klist: Credentials cache keyring 'persistent:1000:krb_ccache_Pzo4C6u' not found
</code></pre><p>Then I lock my screen and unlock it using my Kerberos password, and
now:</p><pre><code>$ klist
Ticket cache: KEYRING:persistent:1000:krb_ccache_rOS6mR8
Default principal: lkellogg@EXAMPLE.COM

Valid starting       Expires              Service principal
07/16/2015 22:45:43  07/17/2015 08:45:43  krbtgt/EXAMPLE.COM@EXAMPLE.COM
  renew until 07/23/2015 22:45:43
</code></pre><h2 id=troubleshooting>Troubleshooting<a href=#troubleshooting class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I found the easiest way to troubleshoot SSSD was to stop the service:</p><pre><code># systemctl stop sssd
</code></pre><p>And then run <code>sssd</code> on the command line in debug mode:</p><pre><code># sssd -d 5 -i
</code></pre><p>This generates logs on <code>stderr</code> and helped me identity problems in my
configuration.</p><h2 id=kudos>Kudos<a href=#kudos class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Thanks to Jakub Hrozek for suggesting the use of the a proxy identity
provider to overcome the limitation on combining Kerberos with the
<code>local</code> provider.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>