<!doctype html><html lang=en><head><title>Provider external networks (in an appropriate amount of detail) :: blog.oddbit.com</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In Quantum in Too Much Detail, I discussed the architecture of a Neutron deployment in detail. Since that article was published, Neutron gained the ability to handle multiple external networks with a single L3 agent. While I wrote about that back in 2014, I covered the configuration side of it in much more detail than I discussed the underlying network architecture. This post addresses the architecture side.
The players This document describes the architecture that results from a particular OpenStack configuration, specifically:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2015-08-13-provider-external-networks-det/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Provider external networks (in an appropriate amount of detail)"><meta property="og:description" content="In Quantum in Too Much Detail, I discussed the architecture of a Neutron deployment in detail. Since that article was published, Neutron gained the ability to handle multiple external networks with a single L3 agent. While I wrote about that back in 2014, I covered the configuration side of it in much more detail than I discussed the underlying network architecture. This post addresses the architecture side.
The players This document describes the architecture that results from a particular OpenStack configuration, specifically:"><meta property="og:url" content="https://blog.oddbit.com/post/2015-08-13-provider-external-networks-det/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2015-08-13 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2015-08-13-provider-external-networks-det/>Provider external networks (in an appropriate amount of detail)</a></h1><div class=post-meta><time class=post-date>2015-08-13 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/openstack/>openstack</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/neutron/>neutron</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/openvswitch/>openvswitch</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/networking/>networking</a>&nbsp;</span><div class=post-content><div><p>In <a href=https://blog.oddbit.com/post/2013-11-14-quantum-in-too-much-detail/>Quantum in Too Much Detail</a>, I discussed the architecture of a
Neutron deployment in detail. Since that article was published,
Neutron gained the ability to handle multiple external networks with a
single L3 agent. While I <a href=https://blog.oddbit.com/post/2014-05-28-multiple-external-networks-wit/>wrote about that</a> back in 2014, I
covered the configuration side of it in much more detail than I
discussed the underlying network architecture. This post addresses
the architecture side.</p><h2 id=the-players>The players<a href=#the-players class=hanchor arialabel=Anchor>&#8983;</a></h2><p>This document describes the architecture that results from a
particular OpenStack configuration, specifically:</p><ul><li>Neutron networking using VXLAN or GRE tunnels;</li><li>A dedicated network controller;</li><li>Two external networks</li></ul><h2 id=the-lay-of-the-land>The lay of the land<a href=#the-lay-of-the-land class=hanchor arialabel=Anchor>&#8983;</a></h2><p>This is a simplified architecture diagram of the network connectivity
in this scenario:</p><p>Everything on the compute hosts is identical to <a href=https://blog.oddbit.com/post/2013-11-14-quantum-in-too-much-detail/>my previous
article</a>, so I will only be discussing the network host here.</p><p>For the purposes of this article, we have two external networks and
two internal networks defined:</p><pre><code>$ neutron net-list
+--------------------------------------+-----------+----------...------------------+
| id                                   | name      | subnets  ...                  |
+--------------------------------------+-----------+----------...------------------+
| 6f0a5622-4d2b-4e4d-b34a-09b70cacf3f1 | net1      | beb767f8-... 192.168.101.0/24 |
| 972f2853-2ba6-474d-a4be-a400d4e3dc97 | net2      | f6d0ca0f-... 192.168.102.0/24 |
| 12136507-9bbe-406f-b68b-151d2a78582b | external2 | 106db3d6-... 172.24.5.224/28  |
| 973a6eb3-eaf8-4697-b90b-b30315b0e05d | external1 | fe8e8193-... 172.24.4.224/28  |
+--------------------------------------+-----------+----------...------------------+
</code></pre><p>And two routers:</p><pre><code>$ neutron router-list
+--------------------------------------+---------+-----------------------...-------------------+...
| id                                   | name    | external_gateway_info ...                   |...
+--------------------------------------+---------+-----------------------...-------------------+...
| 1b19e179-5d67-4d80-8449-bab42119a4c5 | router2 | {&quot;network_id&quot;: &quot;121365... &quot;172.24.5.226&quot;}]} |...
| e2117de3-58ca-420d-9ac6-c4eccf5e7a53 | router1 | {&quot;network_id&quot;: &quot;973a6e... &quot;172.24.4.227&quot;}]} |...
+--------------------------------------+---------+-----------------------...-------------------+...
</code></pre><p>And our logical connectivity is:</p><pre><code>+---------+    +----------+    +-------------+
|         |    |          |    |             |
|  net1   +----&gt; router1  +----&gt;  external1  |
|         |    |          |    |             |
+---------+    +----------+    +-------------+

+---------+    +----------+    +-------------+
|         |    |          |    |             |
|  net2   +----&gt; router2  +----&gt;  external2  |
|         |    |          |    |             |
+---------+    +----------+    +-------------+
</code></pre><h2 id=router-attachments-to-integration-bridge>Router attachments to integration bridge<a href=#router-attachments-to-integration-bridge class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In the <a href=https://blog.oddbit.com/post/2013-11-14-quantum-in-too-much-detail/>legacy model</a>, in which an L3 agent supported a single
external network, the <code>qrouter-...</code> namespaces that implement Neutron
routers were attached to both the integration bridge <code>br-int</code> and the
external network bridge (the <code>external_network_bridge</code> configuration
option from your <code>l3_agent.ini</code>, often named <code>br-ex</code>).</p><p>In the provider network model, <em>both</em> interfaces in a <code>qrouter</code>
namespace are attached to the integration bridge. For the
configuration we&rsquo;ve described above, the configuration of the
integration bridge ends up looking something like:</p><pre><code>Bridge br-int
    fail_mode: secure
    Port &quot;qvoc532d46c-33&quot;
        tag: 3
        Interface &quot;qvoc532d46c-33&quot;
    Port br-int
        Interface br-int
            type: internal
    Port &quot;qg-09e9da38-fb&quot;
        tag: 4
        Interface &quot;qg-09e9da38-fb&quot;
            type: internal
    Port &quot;qvo3ccea690-c2&quot;
        tag: 2
        Interface &quot;qvo3ccea690-c2&quot;
    Port &quot;int-br-ex2&quot;
        Interface &quot;int-br-ex2&quot;
            type: patch
            options: {peer=&quot;phy-br-ex2&quot;}
    Port &quot;tapd2ff89e7-16&quot;
        tag: 2
        Interface &quot;tapd2ff89e7-16&quot;
            type: internal
    Port patch-tun
        Interface patch-tun
            type: patch
            options: {peer=patch-int}
    Port &quot;int-br-ex1&quot;
        Interface &quot;int-br-ex1&quot;
            type: patch
            options: {peer=&quot;phy-br-ex1&quot;}
    Port &quot;qr-affdbcee-5c&quot;
        tag: 3
        Interface &quot;qr-affdbcee-5c&quot;
            type: internal
    Port &quot;qr-b37877cd-42&quot;
        tag: 2
        Interface &quot;qr-b37877cd-42&quot;
            type: internal
    Port &quot;qg-19250d3f-5c&quot;
        tag: 1
        Interface &quot;qg-19250d3f-5c&quot;
            type: internal
    Port &quot;tap0881edf5-e5&quot;
        tag: 3
        Interface &quot;tap0881edf5-e5&quot;
            type: internal
</code></pre><p>The <code>qr-...</code> interface on each router is attached to an internal
network. The VLAN tag associated with this interface is whatever VLAN
Neutron has selected internally for the private network. In the above
output, these ports are on the network named <code>net1</code>:</p><pre><code>Port &quot;qr-affdbcee-5c&quot;
    tag: 3
    Interface &quot;qr-affdbcee-5c&quot;
        type: internal
Port &quot;tap0881edf5-e5&quot;
    tag: 3
    Interface &quot;tap0881edf5-e5&quot;
        type: internal
</code></pre><p>Where <code>qr-affdbcee-5c</code> is <code>router1</code>&rsquo;s interface on that network, and
<code>tap0881edf5-e5</code> is the port attached to a <code>dhcp-...</code> namespace. The
same router is attached to the <code>external1</code> network; this attachment is
represented by:</p><pre><code>Port &quot;qg-09e9da38-fb&quot;
    tag: 4
    Interface &quot;qg-09e9da38-fb&quot;
        type: internal
</code></pre><p>The external bridges are connected to the integration bridge using OVS
&ldquo;patch&rdquo; interfaces (the <code>int-br-ex1</code> on the integration bridge and the
<code>phy-br-ex1</code> interface on the <code>br-ex1</code>).</p><h2 id=from-here-to-there>From here to there<a href=#from-here-to-there class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Connectivity between the <code>qg-...</code> interface and the appropriate
external bridge (<code>br-ex1</code> in this case) happens due to the VLAN tag
assigned on egress by the <code>qg-...</code> interface and the following
OpenFlow rules associated with <code>br-ex1</code>:</p><pre><code># ovs-ofctl dump-flows br-ex1
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=794.876s, table=0, n_packets=0, n_bytes=0, idle_age=794, priority=1 actions=NORMAL
 cookie=0x0, duration=785.833s, table=0, n_packets=0, n_bytes=0, idle_age=785, priority=4,in_port=3,dl_vlan=4 actions=strip_vlan,NORMAL
 cookie=0x0, duration=792.945s, table=0, n_packets=24, n_bytes=1896, idle_age=698, priority=2,in_port=3 actions=drop
</code></pre><p>Each of these rules contains some state information (like the
packet/byte counts), some conditions (like
<code>priority=4,in_port=3,dl_vlan=4</code>) and one or more actions (like
<code>actions=strip_vlan,NORMAL</code>). So, the second rule there matches
packets associated with VLAN tag 4 and strips the VLAN tag (after
which the packet is delivered to any physical interfaces that are
attached to this OVS bridge).</p><p>Putting this all together:</p><ol><li><p>An outbound packet from a Nova server running on a compute node
enters via <code>br-tun</code> (<strong>H</strong>)</p></li><li><p>Flow rules on <code>br-tun</code> translate the tunnel id into an internal
VLAN tag.</p></li><li><p>The packet gets delivered to the <code>qr-...</code> interface of the
appropriate router. (<strong>O</strong>)</p></li><li><p>The packet exits the <code>qg-...</code> interface of the router (where it
is assigned the VLAN tag associated with the external network).
(<strong>N</strong>)</p></li><li><p>The packet is delivered to the external bridge, where a flow rule
strip the VLAN tag. (<strong>P</strong>)</p></li><li><p>The packet is sent out the physical interface associated with the
bridge.</p></li></ol><h2 id=for-the-sake-of-completeness>For the sake of completeness<a href=#for-the-sake-of-completeness class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The second private network, <code>net2</code>, is attached to <code>router2</code> on the
<code>qr-b37877cd-42</code> interface. It exits on the <code>qg-19250d3f-5c</code>
interface, where packets will be assigned to VLAN 1:</p><pre><code>Port &quot;qr-b37877cd-42&quot;
    tag: 2
    Interface &quot;qr-b37877cd-42&quot;
        type: internal
Port &quot;qg-19250d3f-5c&quot;
    tag: 1
    Interface &quot;qg-19250d3f-5c&quot;
        type: internal
</code></pre><p>The network interface configuration in the associated router namespace
looks like this:</p><pre><code># ip netns exec qrouter-1b19e179-5d67-4d80-8449-bab42119a4c5 ip a
30: qg-19250d3f-5c: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN 
    link/ether fa:16:3e:01:e9:e3 brd ff:ff:ff:ff:ff:ff
    inet 172.24.5.226/28 brd 172.24.5.239 scope global qg-19250d3f-5c
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe01:e9e3/64 scope link 
       valid_lft forever preferred_lft forever
37: qr-b37877cd-42: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN 
    link/ether fa:16:3e:4c:6c:f2 brd ff:ff:ff:ff:ff:ff
    inet 192.168.102.1/24 brd 192.168.102.255 scope global qr-b37877cd-42
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe4c:6cf2/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><p>OpenFlow rules attached to <code>br-ex2</code> will match these packets:</p><pre><code># ovs-ofctl dump-flows br-ex2
NXST_FLOW reply (xid=0x4):
 cookie=0x0, duration=3841.678s, table=0, n_packets=0, n_bytes=0, idle_age=3841, priority=1 actions=NORMAL
 cookie=0x0, duration=3831.396s, table=0, n_packets=0, n_bytes=0, idle_age=3831, priority=4,in_port=3,dl_vlan=1 actions=strip_vlan,NORMAL
 cookie=0x0, duration=3840.085s, table=0, n_packets=26, n_bytes=1980, idle_age=3742, priority=2,in_port=3 actions=drop
</code></pre><p>We can see that the second rule here will patch traffic on VLAN 1
(<code>priority=4,in_port=3,dl_vlan=1</code>) and strip the VLAN tag, after which
the packet will be delivered to any other interfaces attached to this
bridge.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>