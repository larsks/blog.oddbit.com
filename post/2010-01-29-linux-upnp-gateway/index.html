<!doctype html><html lang=en><head><title>Linux UPnP Gateway :: blog.oddbit.com</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Like many other folks out there, I have several computers in my house connected to the outside world via a Linux box acting as a NAT gateway. I often want to use application such as BitTorrent and Freenet, which require that a number of ports be forwarded from my external connection to the particular computer on which I happen to be working. It turns out there&rsquo;s a protocol for this, called UPnP. From Wikipedia:
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.oddbit.com/post/2010-01-29-linux-upnp-gateway/><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1FYT93ENG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1FYT93ENG")}</script><link rel=stylesheet href=https://blog.oddbit.com/styles.css><link rel=stylesheet href=https://blog.oddbit.com/style.css><link rel="shortcut icon" href=https://blog.oddbit.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://blog.oddbit.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Linux UPnP Gateway"><meta property="og:description" content="Like many other folks out there, I have several computers in my house connected to the outside world via a Linux box acting as a NAT gateway. I often want to use application such as BitTorrent and Freenet, which require that a number of ports be forwarded from my external connection to the particular computer on which I happen to be working. It turns out there&rsquo;s a protocol for this, called UPnP. From Wikipedia:
"><meta property="og:url" content="https://blog.oddbit.com/post/2010-01-29-linux-upnp-gateway/"><meta property="og:site_name" content="blog.oddbit.com"><meta property="og:image" content="https://blog.oddbit.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="tech"><meta property="article:published_time" content="2010-01-29 00:00:00 +0000 UTC"></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>the odd bit blog</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>/</a></li><li><a href=https://oddbit.com>/about</a></li><li><a href=/posts>/posts</a></li><li><a href=/tags>/tags</a></li><li><a href=/archive>/archive</a></li><li><a href=/rss.xml>/feed</a></li><li><ul class=menu><li class=menu__trigger>&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://github.com/larsks>→Github</a></li><li><a href=https://hachyderm.io/@larsks>→Mastodon</a></li><li><a href=https://twitter.com/larsks>→Twitter</a></li></ul></li></ul></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.oddbit.com/post/2010-01-29-linux-upnp-gateway/>Linux UPnP Gateway</a></h1><div class=post-meta><time class=post-date>2010-01-29 ::
[Updated :: 2023-02-16]</time></div><span class=post-tags>#<a href=https://blog.oddbit.com/tags/networking/>networking</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/peertopeer/>peertopeer</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/linux/>linux</a>&nbsp;
#<a href=https://blog.oddbit.com/tags/upnp/>upnp</a>&nbsp;</span><div class=post-content><div><p>Like many other folks out there, I have several computers in my house connected to the outside world via a Linux box acting as a NAT gateway. I often want to use application such as BitTorrent and Freenet, which require that a number of ports be forwarded from my external connection to the particular computer on which I happen to be working. It turns out there&rsquo;s a protocol for this, called <a href=http://en.wikipedia.org/wiki/Universal_Plug_and_Play>UPnP</a>. From Wikipedia:</p><blockquote><p>Universal Plug and Play (UPnP) is a set of networking protocols
promulgated by the UPnP Forum. The goals of UPnP are to allow
devices to connect seamlessly and to simplify the implementation of
networks in the home (data sharing, communications, and
entertainment) and in corporate environments for simplified
installation of computer components.</p></blockquote><p>The practical use of UPnP, from my perspective, is that it allows a device or application <em>inside</em> the network to request specific ports to be forwarded on the gateway. This means that what used to be a manual process &ndash; adding the necessary forwarding rules to my iptables configuration &ndash; is now performed automatically, and only when necessary.</p><p>The <a href=http://linux-igd.sourceforge.net/>Linux UPnP Internet Gateway Device</a> project implements a Linux UPnP service. You can download the source from the project web page.</p><p>Using the gateway service is really simple:</p><ol><li><p>Start upnpd:</p><pre><code> # /etc/init.d/upnpd
</code></pre></li><li><p>Start your application. You will see messages like the following in syslog (if you are logging DEBUG level messages):</p><pre><code> Aug  6 20:10:12 arcadia upnpd[19816]: Failure in
   GateDeviceDeletePortMapping: DeletePortMap: Proto:UDP Port:57875
 Aug  6 20:10:12 arcadia upnpd[19816]: AddPortMap: DevUDN:
   uuid:75802409-bccb-40e7-8e6c-fa095ecce13e ServiceID: urn:upnp-org:serviceId:WANIPConn1
  RemoteHost: (null) Prot: UDP ExtPort: 57875 Int: 192.168.1.118.57875
 Aug  6 20:10:12 arcadia upnpd[19816]: Failure in
   GateDeviceDeletePortMapping: DeletePortMap: Proto:UDP Port:11657
 Aug  6 20:10:12 arcadia upnpd[19816]: AddPortMap: DevUDN:
   uuid:75802409-bccb-40e7-8e6c-fa095ecce13e ServiceID: urn:upnp-org:serviceId:WANIPConn1
   RemoteHost: (null) Prot: UDP ExtPort: 11657 Int: 192.168.1.118.11657
</code></pre><p>For each forwarding requested by the client, upnpd first attempts to remove the mapping and then creates a new rule. Exactly how upnp implements these rules on your system is controlled by <code>/etc/upnpd.conf</code> &ndash; if you want to use something other than <em>iptables</em>, or use custom chains, this is where you would make your changes.</p></li><li><p>Look at your firewall rules. Upnpd modifies the <em>FORWARD</em> chain in the <em>filter</em> table and the <em>PREROUTING</em> chain in the <em>nat</em> table. You can change this behavior by editing <code>/etc/upnpd.conf</code>.</p><p>To see forwarding rules:</p><pre><code> # iptables -nL FORWARD
</code></pre><p>The rules might look something like this:</p><pre><code> Chain FORWARD (policy DROP)
 target     prot opt source               destination
 ACCEPT     udp  --  0.0.0.0/0            192.168.1.118       udp dpt:57875
 ACCEPT     udp  --  0.0.0.0/0            192.168.1.118       udp dpt:11657
</code></pre><p>To see prerouting rules:</p><pre><code> # iptables -t nat -vnL PREROUTING
</code></pre><p>The rules might look something like this:</p><pre><code> Chain PREROUTING (policy ACCEPT)
 target     prot opt source               destination
 DNAT       udp  --  0.0.0.0/0            0.0.0.0/0           udp dpt:11657 to:192.168.1.118:11657
 DNAT       udp  --  0.0.0.0/0            0.0.0.0/0           udp dpt:57875 to:192.168.1.118:57875
</code></pre></li><li><p>Upnpd will delete the mappings when they expire. The expiration time may be set by the client, or, if the client specifies no expiration, than by the &ldquo;duration&rdquo; configuration item in /etc/upnpd.conf.</p></li></ol><h1 id=configuration-file>Configuration file<a href=#configuration-file class=hanchor arialabel=Anchor>&#8983;</a></h1><p>The upnpd configuration file (<code>/etc/upnpd.conf</code>) allows you to change various aspects of upnpd&rsquo;s behavior. Of particular interest:</p><ul><li><p><code>insert_forward_rules</code><br>Default: <code>yes</code></p><p>Whether or not upnpd needs to create entries in the <code>FORWARD</code> chain of the <code>filter</code> table. If your <code>FORWARD</code> chain has a policy of <code>DROP</code> you need set to yes.</p></li><li><p><code>forward_chain_name</code><br>Default: <code>FORWARD</code></p><p>Normally, upnpd creates entries in the <code>FORWARD</code> chain. If you have a more advanced firewall setup this may not be the appropriate place to make changes. If you enter a custom name here, you will need to create the corresponding chain:</p><pre><code>  iptables -N my-forward-chain
</code></pre><p>You will also need to call this chain from the <em>FORWARD</em> chain:</p><pre><code>  iptables -A FORWARD -j my-forward-chain
</code></pre></li><li><p><code>prerouting_chain_name</code><br>Default: <code>PREROUTING</code></p><p>Like <code>forward</code>chain<code>name</code>, but for entries in the <code>nat</code> table.</p></li></ul><h1 id=security-considerations>Security considerations<a href=#security-considerations class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Consider the following, from the <a href=http://linux-igd.sourceforge.net/documentation.php>Linux IGD documentation</a>:</p><blockquote><p>UPnP version 1.0, on which this program is based, is inherently flawed&mldr;what appears to have happened is that in Microsoft&rsquo;s first UPnP implementation they weren&rsquo;t concerned with security &mldr;. Simply all they wanted was connectivity&mldr;. The UPnP server, by itself, does no security checking. If it recieves a UPnP request to add a portmapping for some ip address inside the firewall, it just does it. This program will attempt to verify the source ip contained in the UPnP request against the source ip of the actual packet, but as always, these can be forged. The UPnP server makes no attempt to verify this connection with the caller, and therefore it just assumes that whoever asked is the person really wanting it.</p></blockquote><p>In other words, in the battle between security and convenience, UPnP is weighs in heavily on the convenience side. You will have to decide whether this meets your particular requirements.</p></div></div><script src=https://utteranc.es/client.js repo=larsks/blog.oddbit.com issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Lars Kellogg-Stedman</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></div></body></html>