<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>metrics on blog.oddbit.com</title><link>https://blog.oddbit.com/tags/metrics/</link><description>Recent content in metrics on blog.oddbit.com</description><generator>Hugo -- gohugo.io</generator><language>en</language><copyright>Lars Kellogg-Stedman</copyright><lastBuildDate>Mon, 26 Feb 2018 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.oddbit.com/tags/metrics/rss.xml" rel="self" type="application/rss+xml"/><item><title>Grouping aggregation queries in Gnocchi 4.0.x</title><link>https://blog.oddbit.com/post/2018-02-26-grouping-aggregation-queries-i/</link><pubDate>Mon, 26 Feb 2018 00:00:00 +0000</pubDate><guid>https://blog.oddbit.com/post/2018-02-26-grouping-aggregation-queries-i/</guid><description>In this article, we&amp;rsquo;re going to ask Gnocchi (the OpenStack telemetry storage service) how much memory was used, on average, over the course of each day by each project in an OpenStack environment.
Environment I&amp;rsquo;m working with an OpenStack &amp;ldquo;Pike&amp;rdquo; deployment, which means I have Gnocchi 4.0.x. More recent versions of Gnocchi (4.1.x and later) have a new aggregation API called dynamic aggregates, but that isn&amp;rsquo;t available in 4.0.x so in this article we&amp;rsquo;ll be using the legacy /v1/aggregations API.</description><content>&lt;p>In this article, we&amp;rsquo;re going to ask Gnocchi (the OpenStack telemetry
storage service) how much memory was used, on average, over the course
of each day by each project in an OpenStack environment.&lt;/p>
&lt;h2 id="environment">Environment&lt;/h2>
&lt;p>I&amp;rsquo;m working with an OpenStack &amp;ldquo;Pike&amp;rdquo; deployment, which means I have
Gnocchi 4.0.x. More recent versions of Gnocchi (4.1.x and later) have
a new aggregation API called &lt;a href="https://gnocchi.xyz/rest.html#dynamic-aggregates">dynamic aggregates&lt;/a>, but that isn&amp;rsquo;t
available in 4.0.x so in this article we&amp;rsquo;ll be using the legacy
&lt;code>/v1/aggregations&lt;/code> API.&lt;/p>
&lt;h2 id="the-gnocchi-data-model">The Gnocchi data model&lt;/h2>
&lt;p>In Gnocchi, named metrics are associated with &lt;em>resources&lt;/em>. A
&lt;em>resource&lt;/em> corresponds to an object in OpenStack, such as a Nova
instance, or a Neutron network, etc. Metrics on a resource are
created dynamically and depend entirely on which metrics you are
collecting with Ceilometer and delivering to Gnocchi, and two
different resources of the same resource type may have different sets
of metrics.&lt;/p>
&lt;p>The list of metrics available from OpenStack is available in the
&lt;a href="https://docs.openstack.org/ceilometer/latest/admin/telemetry-measurements.html">telemetry documentation&lt;/a>. The &lt;a href="https://docs.openstack.org/ceilometer/latest/admin/telemetry-measurements.html#openstack-compute">metrics available for Nova
servers&lt;/a> include statistics on cpu utilization,
memory utilization, disk read/write operations, network traffic, and
more.&lt;/p>
&lt;p>In this example, we&amp;rsquo;re going to look at the &lt;code>memory.usage&lt;/code> metric.&lt;/p>
&lt;h2 id="building-a-query">Building a query&lt;/h2>
&lt;p>The amount of memory used is available in the &lt;code>memory.usage&lt;/code> metric
associated with each &lt;code>instance&lt;/code> resource. We&amp;rsquo;re using the legacy
&lt;code>/v1/aggregations&lt;/code> API, so the request url will initially look like:&lt;/p>
&lt;pre>&lt;code>/v1/aggregation/resource/instance/metric/memory.usage
&lt;/code>&lt;/pre>
&lt;p>We need to specify which granularity we want to fetch. We&amp;rsquo;re using
the &lt;code>low&lt;/code> archive policy from the default Gnocchi configuration which
means we only have one option (metrics are aggregated into 5 minute
intervals). We use the &lt;code>granularity&lt;/code> parameter to tell Gnocchi which
granularity we want:&lt;/p>
&lt;pre>&lt;code>.../metric/memory.usage?granularity=300
&lt;/code>&lt;/pre>
&lt;p>We want the average utilization, so that means:&lt;/p>
&lt;pre>&lt;code>.../metric/memory.usage?granularity=300&amp;amp;aggregation=mean
&lt;/code>&lt;/pre>
&lt;p>We&amp;rsquo;d like to limit this to the past 30 days of data, so we&amp;rsquo;ll add an
appropriate &lt;code>start&lt;/code> parameter. There are various ways of specifying
time in Gnocchi, documented in the &lt;a href="https://gnocchi.xyz/rest.html#timestamp-format">Timestamps&lt;/a> section of the docs.
Specifying &amp;ldquo;30 days ago&amp;rdquo; is as simple as: &lt;code>start=-30+days&lt;/code>. So our
request now looks like:&lt;/p>
&lt;pre>&lt;code>.../metric/memory.usage?granularity=300&amp;amp;aggregation=mean&amp;amp;start=-30+days
&lt;/code>&lt;/pre>
&lt;p>We have values at 5 minute intervals, but we would like daily
averages, so we&amp;rsquo;ll need to use the &lt;a href="https://gnocchi.xyz/rest.html#resample">resample&lt;/a> parameter to ask
Gnocchi to reshape the data for us. The argument to &lt;code>resample&lt;/code> is a
time period specified as a number of seconds; since we want daily
averages, that means &lt;code>resample=86400&lt;/code>:&lt;/p>
&lt;pre>&lt;code>.../metric/memory.usage?granularity=300&amp;amp;aggregation=mean&amp;amp;start=-30+days&amp;amp;resample=86400
&lt;/code>&lt;/pre>
&lt;p>We want to group the results by project, which means we&amp;rsquo;ll need the
&lt;code>groupby&lt;/code> parameter. Instances (and most other resources) store this
information in the &lt;code>project_id&lt;/code> attribute, so &lt;code>groupby=project_id&lt;/code>:&lt;/p>
&lt;pre>&lt;code>.../metric/memory.usage?granularity=300&amp;amp;aggregation=mean&amp;amp;start=-30+days&amp;amp;resample=86400&amp;amp;groupby=project_id
&lt;/code>&lt;/pre>
&lt;p>Lastly, not all metrics will have measurements covering the same
period. If we were to try the query as we have it right now, we would
probably see:&lt;/p>
&lt;pre>&lt;code>400 Bad Request
The server could not comply with the request since it is either
malformed or otherwise incorrect.
One of the metrics being aggregated doesn't have matching
granularity: Metrics &amp;lt;list of metrics here&amp;gt;...can't be aggregated:
No overlap
&lt;/code>&lt;/pre>
&lt;p>Gnocchi provides a &lt;code>fill&lt;/code> parameter to indicate what should happen
with missing data. In Gnocchi 4.0.x, the options are &lt;code>fill=0&lt;/code>
(replace missing data with &lt;code>0&lt;/code>) and &lt;code>fill=null&lt;/code> (compute the
aggregation using only available data points). Selecting &lt;code>fill=0&lt;/code> gets
us:&lt;/p>
&lt;pre>&lt;code>.../metric/memory.usage?granularity=300&amp;amp;aggregation=mean&amp;amp;start=-30+days&amp;amp;resample=86400&amp;amp;groupby=project_id&amp;amp;fill=0
&lt;/code>&lt;/pre>
&lt;p>That should give us the results we want. The return value from that
query looks something like this:&lt;/p>
&lt;pre>&lt;code>[
{
&amp;quot;group&amp;quot;: {
&amp;quot;project_id&amp;quot;: &amp;quot;00a8d5e942bb442b86733f0f92280fcc&amp;quot;
},
&amp;quot;measures&amp;quot;: [
[
&amp;quot;2018-02-14T00:00:00+00:00&amp;quot;,
86400.0,
2410.014338235294
],
[
&amp;quot;2018-02-15T00:00:00+00:00&amp;quot;,
86400.0,
2449.4921970791206
],
.
.
.
{
&amp;quot;group&amp;quot;: {
&amp;quot;project_id&amp;quot;: &amp;quot;03d2a1de5b2342d78d14e5294a81e0b0&amp;quot;
},
&amp;quot;measures&amp;quot;: [
[
&amp;quot;2018-02-14T00:00:00+00:00&amp;quot;,
86400.0,
381.0
],
[
&amp;quot;2018-02-15T00:00:00+00:00&amp;quot;,
86400.0,
380.99004975124376
],
[
&amp;quot;2018-02-16T00:00:00+00:00&amp;quot;,
86400.0,
380.99305555555554
],
.
.
.
&lt;/code>&lt;/pre>
&lt;h2 id="authenticating-to-gnocchi">Authenticating to Gnocchi&lt;/h2>
&lt;p>Since we&amp;rsquo;re using Gnocchi as part of an OpenStack deployment, we&amp;rsquo;ll
be authenticating to Gnocchi using a Keystone token. Let&amp;rsquo;s take a
look at how you could do that from the command line using &lt;code>curl&lt;/code>.&lt;/p>
&lt;h3 id="acquiring-a-token">Acquiring a token&lt;/h3>
&lt;p>You can acquire a token using the &lt;code>openstack token issue&lt;/code> command,
which will produce output like:&lt;/p>
&lt;pre>&lt;code>+------------+------------------------------------------------------------------------+
| Field | Value |
+------------+------------------------------------------------------------------------+
| expires | 2018-02-26T23:09:36+0000 |
| id | ... |
| project_id | c53c18b2d29641e0877bbbd8d87f8267 |
| user_id | 533ad9ab4fed403fb98f1ffc2f2b4436 |
+------------+------------------------------------------------------------------------+
&lt;/code>&lt;/pre>
&lt;p>While it is possible to parse that with, say, &lt;code>awk&lt;/code>, it&amp;rsquo;s not
really designed to be machine readable. We can get just the token
value by instead calling:&lt;/p>
&lt;pre>&lt;code>openstack token issue -c id -f value
&lt;/code>&lt;/pre>
&lt;p>We should probably store that in a variable:&lt;/p>
&lt;pre>&lt;code>TOKEN=$(openstack token issue -c id -f value)
&lt;/code>&lt;/pre>
&lt;h3 id="querying-gnocchi">Querying Gnocchi&lt;/h3>
&lt;p>In order to make our command line shorter, let&amp;rsquo;s set &lt;code>ENDPOINT&lt;/code> to the
URL of our Gnocchi endpoint:&lt;/p>
&lt;pre>&lt;code>ENDPOINT=http://cloud.example.com:8041/v1
&lt;/code>&lt;/pre>
&lt;p>We&amp;rsquo;ll pass the Keystone token in the &lt;code>X-Auth-Token&lt;/code> header. Gnocchi
is expecting a JSON document body as part of this request (you can use
that to specify a filter; see the &lt;a href="https://gnocchi.xyz/rest.html">API documentation&lt;/a> for details),
so we need to both set a &lt;code>Content-type&lt;/code> header and provide at least an
empty JSON object. That makes our final request look like:&lt;/p>
&lt;pre>&lt;code>curl \
-H &amp;quot;X-Auth-Token: $TOKEN&amp;quot; \
-H &amp;quot;Content-type: application/json&amp;quot; \
-d &amp;quot;{}&amp;quot; \
&amp;quot;$ENDPOINT/aggregation/resource/instance/metric/memory.usage?granularity=300&amp;amp;aggregation=mean&amp;amp;start=-30+days&amp;amp;resample=86400&amp;amp;groupby=project_id&amp;amp;fill=0&amp;quot;
&lt;/code>&lt;/pre></content></item></channel></rss>